<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Minimal Tasks UI</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <style>
    :root {
      --bg: #f7f7f9;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --border-soft: #f1f5f9;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #eff4ff;
      --radius-lg: 14px;
      --radius-md: 10px;
      --sheet-header-height: 40px;
      --green: #16a34a;
      --red: #b91c1c;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      overflow: hidden;
      height: 100vh;
    }

    .app {
      position: relative;
      width: 100%;
      max-width: 520px;
      height: 100vh;
      padding: 12px 14px 70px;
      overflow: hidden;
    }

    /* é¡¶éƒ¨ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .header-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .header-title h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .header-title span {
      font-size: 12px;
      color: var(--muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-refresh {
      font-size: 11px;
      background: transparent;
      border: none;
      padding: 2px 4px;
      cursor: pointer;
      color: var(--muted);
    }

    .header-refresh.ok {
      color: var(--green);
    }

    .header-refresh.error {
      color: var(--red);
    }

    .header-settings {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #4b5563;
      cursor: pointer;
    }

    .header-settings:active {
      transform: scale(0.95);
      background: #e5e7eb;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      background: #edf0f4;
      padding: 4px;
      border-radius: 999px;
      margin-bottom: 10px;
    }

    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 7px 0;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .tab-btn span.badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #4b5563;
    }

    .tab-btn.active {
      background: var(--bg-card);
      color: var(--text);
      box-shadow: 0 1px 2px rgba(15,23,42,0.05);
    }

    .tab-btn.active span.badge {
      background: var(--accent-soft);
      color: var(--accent);
    }

    /* ä¸»å†…å®¹åŒºåŸŸ */
    .main {
      position: relative;
      height: calc(100vh - 120px);
      overflow: hidden;
    }

    .panel {
      display: none;
      height: 100%;
      overflow-y: auto;
      padding-bottom: 10px;
    }
    .panel.active {
      display: block;
    }

    .section-title {
      font-size: 13px;
      font-weight: 500;
      margin: 10px 2px 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title span.count {
      font-size: 11px;
      color: var(--muted);
    }

    .empty {
      padding: 18px 4px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    /* ä»Šæ—¥è§†å›¾ä»»åŠ¡å¡ */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    .task-card-today {
      padding: 10px 11px;
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      display: flex;
      gap: 8px;
      align-items: flex-start;
      cursor: pointer;
    }

    .task-checkbox {
      margin-top: 3px;
      flex-shrink: 0;
    }

    .task-main {
      flex: 1;
      min-width: 0;
    }

    .task-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .task-desc {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .task-title.completed,
    .task-desc.completed {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .overdue-label {
      font-size: 11px;
      color: var(--red);
      margin-top: 4px;
    }

    /* å‘¨è§†å›¾ */
    .week-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      grid-template-rows: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
      padding-bottom: 10px;
    }

    .week-day-card {
      border-radius: var(--radius-md);
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      padding: 8px 8px 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 160px;
      max-height: 220px;
    }

    .week-day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .week-day-title {
      font-size: 11px;
      font-weight: 500;
      color: #4b5563;
    }

    .week-day-count {
      font-size: 10px;
      color: var(--muted);
    }

    .week-day-card.today {
      border-color: var(--accent);
      background: #eff6ff;
    }

    .week-tasks {
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow: hidden;
    }

    .week-task-title {
      font-size: 11px;
      color: #374151;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .week-task-title.empty {
      color: var(--muted);
      cursor: default;
    }

    /* Inbox æŠ½å±‰ */
    .inbox-sheet {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 75vh;
      max-height: 75vh;
      background: var(--bg-card);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -4px 12px rgba(15,23,42,0.12);
      transform: translateY(calc(100% - var(--sheet-header-height)));
      transition: transform 0.18s ease-out;
      display: flex;
      flex-direction: column;
      z-index: 20;
    }

    .inbox-sheet.expanded {
      transform: translateY(0);
    }

    .inbox-header {
      height: var(--sheet-header-height);
      padding: 6px 14px 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: grab;
    }

    .inbox-header-label {
      font-size: 12px;
      color: var(--muted);
    }

    .inbox-drag-handle {
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 4px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .inbox-content {
      flex: 1;
      overflow-y: auto;
      padding: 4px 10px 10px;
      background: #f9fafb;
    }

    .inbox-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-bottom: 20px;
    }

    .inbox-item {
      padding: 9px 10px;
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .inbox-main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .inbox-title {
      font-size: 13px;
      font-weight: 500;
    }

    .inbox-desc {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* æ‚¬æµ®æŒ‰é’®ï¼šè§„åˆ’ + æ–°å»º */
    .fab-container {
      position: absolute;
      right: 16px;
      bottom: 70px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 30;
      pointer-events: none;
    }

    .fab {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      box-shadow: 0 6px 16px rgba(15,23,42,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #4b5563;
      cursor: pointer;
      pointer-events: auto;
    }

    .fab:active {
      transform: scale(0.95);
      background: #f3f4f6;
    }

    /* è§„åˆ’é¢æ¿ï¼šå±…ä¸­å¤§å¡ç‰‡ */
    .planner-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 45;
    }

    .planner-backdrop.open {
      display: flex;
    }

    .planner-sheet {
      width: 92%;
      max-width: 520px;
      border-radius: 18px;
      background: var(--bg-card);
      box-shadow: 0 12px 30px rgba(15,23,42,0.32);
      padding: 12px 14px 16px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .planner-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .planner-progress {
      font-size: 12px;
      color: var(--muted);
      margin-left: auto;
      margin-right: 8px;
    }

    .planner-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    .planner-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: #6b7280;
    }

    .planner-card {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      padding: 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .planner-task-title {
      font-size: 14px;
      font-weight: 500;
    }

    .planner-task-desc {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .planner-action-row {
      margin-top: 4px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .planner-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      padding: 6px 10px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 6px;
      font-size: 13px;
      cursor: pointer;
      color: #374151;
    }

    .planner-btn:active {
      transform: scale(0.97);
      background: #f3f4f6;
    }

    .planner-btn-icon {
      font-size: 16px;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .planner-empty {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      padding: 20px 0 6px;
    }

    /* Notion iframe å¼¹å±‚ */
    .notion-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.25);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .notion-backdrop.open {
      display: flex;
    }

    .notion-frame-wrap {
      width: 100%;
      max-width: 520px;
      height: 100vh;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
    }

    .notion-toolbar {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      background: #f3f4f6;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      color: var(--muted);
    }

    .notion-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: #6b7280;
    }

    .notion-iframe {
      flex: 1;
      border: none;
      width: 100%;
    }

    /* æ–°å»ºä»»åŠ¡å¼¹å±‚ */
    .newtask-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 46;
    }

    .newtask-backdrop.open {
      display: flex;
    }

    .newtask-card {
      width: 92%;
      max-width: 480px;
      border-radius: 16px;
      background: var(--bg-card);
      padding: 12px 14px 14px;
      box-shadow: 0 12px 30px rgba(15,23,42,0.32);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .newtask-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .newtask-title {
      font-size: 14px;
      font-weight: 500;
    }

    .newtask-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: #6b7280;
    }

    .newtask-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 4px;
    }

    .newtask-label {
      font-size: 12px;
      color: var(--muted);
    }

    .newtask-input,
    .newtask-textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
    }

    .newtask-input:focus,
    .newtask-textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.2);
    }

    .newtask-textarea {
      resize: vertical;
      min-height: 60px;
    }

    .newtask-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 5px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn.primary {
      border-color: var(--accent);
      background: var(--accent);
      color: white;
    }

    .btn.primary:active {
      opacity: 0.9;
    }

    .btn:active {
      transform: scale(0.98);
    }

  </style>
</head>
<body>
  <div class="app">
    <!-- é¡¶éƒ¨æ—¥æœŸ -->
    <header class="header">
      <div class="header-title">
        <h1 id="headerDate"></h1>
        <span id="todayLabel"></span>
      </div>
      <div class="header-right">
        <button class="header-refresh" id="refreshLabel" title="ç‚¹å‡»åˆ·æ–°">æœ€è¿‘æ›´æ–° â€”</button>
        <button class="header-settings" id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="today">
        ä»Šæ—¥
        <span class="badge" id="badgeToday">0</span>
      </button>
      <button class="tab-btn" data-tab="week">
        ä¸€å‘¨
        <span class="badge" id="badgeWeek">0</span>
      </button>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main">
      <!-- ä»Šæ—¥ -->
      <section class="panel active" data-panel="today">
        <div class="section-title">
          <span>é€¾æœŸä»»åŠ¡</span>
          <span class="count" id="countOverdue">0 é¡¹</span>
        </div>
        <div class="task-list" id="listOverdue"></div>

        <div class="section-title">
          <span>ä»Šæ—¥ä»»åŠ¡</span>
          <span class="count" id="countToday">0 é¡¹</span>
        </div>
        <div class="task-list" id="listToday"></div>
      </section>

      <!-- ä¸€å‘¨è§†å›¾ -->
      <section class="panel" data-panel="week">
        <div class="section-title">
          <span>æœ¬å‘¨</span>
          <span class="count" id="countWeek">0 é¡¹</span>
        </div>
        <div class="week-grid" id="weekGrid"></div>
      </section>
    </div>

    <!-- Inbox æŠ½å±‰ -->
    <div class="inbox-sheet" id="inboxSheet">
      <div class="inbox-header" id="inboxHandle">
        <div class="inbox-drag-handle"></div>
        <span class="inbox-header-label">Inbox Â· <span id="inboxCountLabel">0</span> é¡¹</span>
      </div>
      <div class="inbox-content">
        <div class="inbox-list" id="listInbox"></div>
      </div>
    </div>

    <!-- æ‚¬æµ®æŒ‰é’®ï¼šè§„åˆ’ + æ–°å»º -->
    <div class="fab-container">
      <button class="fab" id="planFab" title="è§„åˆ’">ğŸ§­</button>
      <button class="fab" id="addFab" title="æ–°å»º">âœš</button>
    </div>
  </div>

  <!-- è§„åˆ’é¢æ¿ -->
  <div class="planner-backdrop" id="plannerBackdrop">
    <div class="planner-sheet">
      <div class="planner-header">
        <span class="planner-title">å¿«é€Ÿè§„åˆ’</span>
        <div class="planner-progress" id="plannerProgress"></div>
        <button class="planner-close" id="plannerClose">Ã—</button>
      </div>
      <div id="plannerContent"></div>
    </div>
  </div>

  <!-- Notion å¼¹å±‚ -->
  <div class="notion-backdrop" id="notionBackdrop">
    <div class="notion-frame-wrap">
      <div class="notion-toolbar">
        <span>Notion</span>
        <button class="notion-close" id="notionClose">Ã—</button>
      </div>
      <iframe id="notionFrame" class="notion-iframe" src=""></iframe>
    </div>
  </div>

  <!-- æ–°å»ºä»»åŠ¡å¼¹å±‚ -->
  <div class="newtask-backdrop" id="newtaskBackdrop">
    <div class="newtask-card">
      <div class="newtask-header">
        <span class="newtask-title">æ–°å»ºä»»åŠ¡</span>
        <button class="newtask-close" id="newtaskClose">Ã—</button>
      </div>
      <div class="newtask-row">
        <span class="newtask-label">æ ‡é¢˜</span>
        <input type="text" id="newTitle" class="newtask-input" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜" />
      </div>
      <div class="newtask-row">
        <span class="newtask-label">å¤‡æ³¨</span>
        <textarea id="newDesc" class="newtask-textarea" placeholder="è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰"></textarea>
      </div>
      <div class="newtask-row">
        <span class="newtask-label">æ—¥æœŸï¼ˆYYYY-MM-DDï¼Œå¯ç•™ç©ºï¼‰</span>
        <input type="text" id="newDate" class="newtask-input" placeholder="ä¾‹å¦‚ 2025-12-09" />
      </div>
      <div class="newtask-footer">
        <button class="btn" id="newCancel">å–æ¶ˆ</button>
        <button class="btn primary" id="newSave">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // ------ å…¨å±€é…ç½® ------
    const API_BASE = ""; // åŒæºæ—¶ç•™ç©ºï¼›è‹¥åç«¯åœ¨ http://localhost:8000ï¼Œåˆ™å¡« "http://localhost:8000"
    const PENDING_KEY = "notionTaskPending";

    let tasks = [];
    const taskMap = {};

    let plannerQueue = [];
    let plannerIndex = 0;

    let lastUpdated = null;
    let refreshLabelEl = null;
    let isSyncing = false;

    // ------ æ—¥æœŸå·¥å…·ï¼šç»Ÿä¸€ YYYY-MM-DD ------
    function todayStr() {
      const d = new Date();
      d.setHours(0,0,0,0);
      return d.toISOString().slice(0, 10);
    }

    function offsetDateStr(days) {
      const d = new Date();
      d.setDate(d.getDate() + days);
      d.setHours(0,0,0,0);
      return d.toISOString().slice(0, 10);
    }

    function dateKey(dateStr) {
      return dateStr || null;
    }

    function isSameDayStr(a, b) {
      return a && b && dateKey(a) === dateKey(b);
    }

    function getWeekDatesMonToSun() {
      const today = new Date();
      today.setHours(0,0,0,0);
      const day = today.getDay();
      const mondayOffset = day === 0 ? -6 : 1 - day;
      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + mondayOffset + i);
        d.setHours(0,0,0,0);
        days.push(d);
      }
      return days; // Date å¯¹è±¡æ•°ç»„
    }

    function weekdayLabelShort(d) {
      const map = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
      return "å‘¨" + map[d.getDay()];
    }

    function formatDateShortStr(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return `${d.getMonth() + 1}/${d.getDate()}`;
    }

    function initHeaderDate() {
      const headerDate = document.getElementById("headerDate");
      const label = document.getElementById("todayLabel");
      const d = new Date();
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      const day = d.getDate();
      const weekdays = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
      const w = weekdays[d.getDay()];
      headerDate.textContent = `${y}å¹´${m}æœˆ${day}æ—¥`;
      label.textContent = `å‘¨${w}`;
    }

    function formatTimeHHMM(d) {
      const h = d.getHours().toString().padStart(2,"0");
      const m = d.getMinutes().toString().padStart(2,"0");
      return `${h}:${m}`;
    }

    // ------ pendingChanges & åŒæ­¥çŠ¶æ€ ------
    function getPendingChanges() {
      try {
        const raw = localStorage.getItem(PENDING_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        return [];
      }
    }

    function setPendingChanges(arr) {
      localStorage.setItem(PENDING_KEY, JSON.stringify(arr));
      updateSyncStatusUI();
    }

    function addPendingChange(change) {
      const pending = getPendingChanges();
      pending.push(change);
      setPendingChanges(pending);
      processPendingChanges();
    }

    function updateSyncStatusUI() {
      if (!refreshLabelEl) return;
      const pending = getPendingChanges();
      refreshLabelEl.classList.remove("ok","error");
      if (pending.length > 0) {
        refreshLabelEl.classList.add("error");
        refreshLabelEl.textContent = `æœªåŒæ­¥ ${pending.length} é¡¹`;
      } else if (lastUpdated) {
        refreshLabelEl.classList.add("ok");
        refreshLabelEl.textContent = `æœ€è¿‘æ›´æ–° ${formatTimeHHMM(lastUpdated)}`;
      } else {
        refreshLabelEl.textContent = "æœ€è¿‘æ›´æ–° â€”";
      }
    }

    // ä¸²è¡Œå¤„ç† pendingChanges
    function processPendingChanges() {
      if (isSyncing) return;
      const pending = getPendingChanges();
      if (pending.length === 0) {
        updateSyncStatusUI();
        return;
      }
      isSyncing = true;
      const change = pending[0];

      if (change.type === "create") {
        // POST /api/tasks
        fetch(API_BASE + "/api/tasks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: change.title,
            description: change.description || null,
            date: change.date || null,
          }),
        })
        .then(res => {
          if (!res.ok) throw new Error("create failed");
          return res.json();
        })
        .then(data => {
          const created = data;
          // æ›¿æ¢ä¸´æ—¶ä»»åŠ¡ id
          tasks = tasks.map(t => {
            if (t.id === change.tempId) {
              return { ...created };
            }
            return t;
          });
          rebuildTaskMap();
          render(tasks);

          // ç§»é™¤ pending
          const rest = getPendingChanges().slice(1);
          setPendingChanges(rest);
          lastUpdated = new Date();
        })
        .catch(err => {
          console.error("create sync error", err);
          // ä¸ç§»é™¤ pendingï¼ŒUI æ˜¾ç¤ºçº¢è‰²
        })
        .finally(() => {
          isSyncing = false;
          updateSyncStatusUI();
          if (getPendingChanges().length > 0) {
            // ç»§ç»­ä¸‹ä¸€æ¡
            processPendingChanges();
          }
        });

      } else if (change.type === "updateDate") {
        // PATCH /api/tasks/{id}/date
        fetch(API_BASE + `/api/tasks/${encodeURIComponent(change.id)}/date`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ date: change.date || null }),
        })
        .then(res => {
          if (!res.ok) throw new Error("updateDate failed");
          return res.json();
        })
        .then(data => {
          const updated = data;
          tasks = tasks.map(t => t.id === updated.id ? { ...updated } : t);
          rebuildTaskMap();
          render(tasks);

          const rest = getPendingChanges().slice(1);
          setPendingChanges(rest);
          lastUpdated = new Date();
        })
        .catch(err => {
          console.error("updateDate sync error", err);
        })
        .finally(() => {
          isSyncing = false;
          updateSyncStatusUI();
          if (getPendingChanges().length > 0) {
            processPendingChanges();
          }
        });
      } else {
        // æœªçŸ¥ç±»å‹ï¼Œä¸¢å¼ƒ
        const rest = getPendingChanges().slice(1);
        setPendingChanges(rest);
        isSyncing = false;
        updateSyncStatusUI();
      }
    }

    // ------ åŠ è½½ä»»åŠ¡ ------
    function loadTasksFromServer() {
      return fetch(API_BASE + "/api/tasks")
        .then(res => {
          if (!res.ok) throw new Error("load tasks failed");
          return res.json();
        })
        .then(data => {
          tasks = data.tasks || [];
          rebuildTaskMap();
          render(tasks);
          lastUpdated = new Date();
          updateSyncStatusUI();
        })
        .catch(err => {
          console.error("loadTasks error", err);
          // åŠ è½½å¤±è´¥å°±åªæ›´æ–°çŠ¶æ€ï¼Œä¸æŠ¹æ‰æ—§æ•°æ®
          updateSyncStatusUI();
        });
    }

    function rebuildTaskMap() {
      Object.keys(taskMap).forEach(k => delete taskMap[k]);
      tasks.forEach(t => taskMap[t.id] = t);
    }

    // ------ æ¸²æŸ“é€»è¾‘ ------
    function render(allTasks) {
      const today = todayStr();

      const withDue = allTasks.filter(t => !!t.date);
      const overdue = withDue.filter(t => t.date < today && t.status !== "å·²å®Œæˆ");
      const todayTasks = withDue.filter(t => isSameDayStr(t.date, today));
      const inbox = allTasks.filter(t => !t.date);

      const weekDates = getWeekDatesMonToSun();
      const weekStart = weekDates[0].toISOString().slice(0,10);
      const weekEnd = weekDates[6].toISOString().slice(0,10);
      const weekTasks = withDue.filter(t => t.date >= weekStart && t.date <= weekEnd);

      document.getElementById("badgeToday").textContent = overdue.length + todayTasks.length;
      document.getElementById("badgeWeek").textContent = weekTasks.length;
      document.getElementById("countOverdue").textContent = overdue.length + " é¡¹";
      document.getElementById("countToday").textContent = todayTasks.length + " é¡¹";
      document.getElementById("countWeek").textContent = weekTasks.length + " é¡¹";
      document.getElementById("inboxCountLabel").textContent = inbox.length;

      // ä»Šæ—¥
      const listOverdue = document.getElementById("listOverdue");
      const listToday = document.getElementById("listToday");
      listOverdue.innerHTML = "";
      listToday.innerHTML = "";

      if (overdue.length === 0) {
        listOverdue.innerHTML = `<div class="empty">æ²¡æœ‰é€¾æœŸä»»åŠ¡</div>`;
      } else {
        overdue
          .slice()
          .sort((a,b) => (a.date || "").localeCompare(b.date || ""))
          .forEach(t => listOverdue.appendChild(createTodayCard(t, { overdue: true })));
      }

      if (todayTasks.length === 0) {
        listToday.innerHTML = `<div class="empty">ä»Šå¤©æ²¡æœ‰ä»»åŠ¡å®‰æ’</div>`;
      } else {
        todayTasks
          .slice()
          .sort((a,b) => (a.title || "").localeCompare(b.title || "", "zh-CN"))
          .forEach(t => listToday.appendChild(createTodayCard(t)));
      }

      // ä¸€å‘¨è§†å›¾
      const weekGrid = document.getElementById("weekGrid");
      weekGrid.innerHTML = "";
      const todayKeyNow = today;

      // Mon..Fri
      for (let i = 0; i < 5; i++) {
        const d = weekDates[i];
        const key = d.toISOString().slice(0,10);
        const dayTasks = weekTasks.filter(t => t.date === key);
        weekGrid.appendChild(createWeekDayCard(d, dayTasks, key === todayKeyNow));
      }

      // å‘¨æœ«åˆå¹¶
      const sat = weekDates[5];
      const sun = weekDates[6];
      const satKey = sat.toISOString().slice(0,10);
      const sunKey = sun.toISOString().slice(0,10);
      const weekendTasks = weekTasks.filter(t => t.date === satKey || t.date === sunKey);
      const isWeekendToday = (today === satKey || today === sunKey);
      weekGrid.appendChild(createWeekendCard(sat, sun, weekendTasks, isWeekendToday));

      // Inbox
      const listInbox = document.getElementById("listInbox");
      listInbox.innerHTML = "";
      if (inbox.length === 0) {
        listInbox.innerHTML = `<div class="empty">æš‚æ—  Inbox ä»»åŠ¡</div>`;
      } else {
        inbox
          .slice()
          .sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || ""))
          .forEach(t => listInbox.appendChild(createInboxItem(t)));
      }

      // æ›´æ–°è§„åˆ’é˜Ÿåˆ—
      buildPlannerQueue(overdue, inbox);
    }

    // ä»Šæ—¥ä»»åŠ¡å¡
    function createTodayCard(task, opt = {}) {
      const card = document.createElement("div");
      card.className = "task-card-today";
      card.dataset.id = task.id;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "task-checkbox";
      checkbox.checked = task.status === "å·²å®Œæˆ";

      const main = document.createElement("div");
      main.className = "task-main";

      const title = document.createElement("div");
      title.className = "task-title";
      title.textContent = task.title || "(æœªå‘½åä»»åŠ¡)";

      const desc = document.createElement("div");
      desc.className = "task-desc";
      desc.textContent = task.description || "";

      if (checkbox.checked) {
        title.classList.add("completed");
        desc.classList.add("completed");
      }

      checkbox.addEventListener("change", (e) => {
        e.stopPropagation();
        const completed = checkbox.checked;
        title.classList.toggle("completed", completed);
        desc.classList.toggle("completed", completed);
        task.status = completed ? "å·²å®Œæˆ" : "å¾…åŠ";
      });

      card.addEventListener("click", () => {
        openNotionPage(task);
      });

      main.appendChild(title);
      if (task.description) main.appendChild(desc);

      if (opt.overdue && task.date) {
        const overdueLabel = document.createElement("div");
        overdueLabel.className = "overdue-label";
        overdueLabel.textContent = "å·²é€¾æœŸ";
        main.appendChild(overdueLabel);
      }

      card.appendChild(checkbox);
      card.appendChild(main);
      return card;
    }

    // å‘¨è§†å›¾å¡ç‰‡
    function createWeekDayCard(dateObj, dayTasks, isToday) {
      const card = document.createElement("div");
      card.className = "week-day-card" + (isToday ? " today" : "");

      const header = document.createElement("div");
      header.className = "week-day-header";

      const title = document.createElement("span");
      title.className = "week-day-title";
      title.textContent = `${weekdayLabelShort(dateObj)} Â· ${formatDateShortStr(dateObj.toISOString().slice(0,10))}`;

      const count = document.createElement("span");
      count.className = "week-day-count";
      count.textContent = `${dayTasks.length} é¡¹`;

      header.appendChild(title);
      header.appendChild(count);

      const list = document.createElement("div");
      list.className = "week-tasks";

      if (dayTasks.length === 0) {
        const empty = document.createElement("div");
        empty.className = "week-task-title empty";
        empty.textContent = "æš‚æ— ä»»åŠ¡";
        list.appendChild(empty);
      } else {
        dayTasks
          .slice()
          .sort((a,b) => (a.title || "").localeCompare(b.title || "", "zh-CN"))
          .forEach(t => {
            const item = document.createElement("div");
            item.className = "week-task-title";
            item.textContent = t.title || "(æœªå‘½åä»»åŠ¡)";
            item.addEventListener("click", () => {
              openNotionPage(t);
            });
            list.appendChild(item);
          });
      }

      card.appendChild(header);
      card.appendChild(list);
      return card;
    }

    function createWeekendCard(sat, sun, weekendTasks, isToday) {
      const card = document.createElement("div");
      card.className = "week-day-card" + (isToday ? " today" : "");

      const header = document.createElement("div");
      header.className = "week-day-header";

      const title = document.createElement("span");
      title.className = "week-day-title";
      title.textContent = `å‘¨æœ« Â· ${formatDateShortStr(sat.toISOString().slice(0,10))} - ${formatDateShortStr(sun.toISOString().slice(0,10))}`;

      const count = document.createElement("span");
      count.className = "week-day-count";
      count.textContent = `${weekendTasks.length} é¡¹`;

      header.appendChild(title);
      header.appendChild(count);

      const list = document.createElement("div");
      list.className = "week-tasks";

      if (weekendTasks.length === 0) {
        const empty = document.createElement("div");
        empty.className = "week-task-title empty";
        empty.textContent = "æš‚æ— ä»»åŠ¡";
        list.appendChild(empty);
      } else {
        weekendTasks
          .slice()
          .sort((a,b) => (a.title || "").localeCompare(b.title || "", "zh-CN"))
          .forEach(t => {
            const item = document.createElement("div");
            item.className = "week-task-title";
            item.textContent = t.title || "(æœªå‘½åä»»åŠ¡)";
            item.addEventListener("click", () => {
              openNotionPage(t);
            });
            list.appendChild(item);
          });
      }

      card.appendChild(header);
      card.appendChild(list);
      return card;
    }

    // Inbox è¡Œ
    function createInboxItem(task) {
      const row = document.createElement("div");
      row.className = "inbox-item";

      const main = document.createElement("div");
      main.className = "inbox-main";

      const title = document.createElement("div");
      title.className = "inbox-title";
      title.textContent = task.title || "(æœªå‘½åä»»åŠ¡)";

      const desc = document.createElement("div");
      desc.className = "inbox-desc";
      desc.textContent = task.description || "";

      main.appendChild(title);
      if (task.description) main.appendChild(desc);

      row.appendChild(main);
      row.addEventListener("click", () => {
        openNotionPage(task);
      });

      return row;
    }

    // Notion iframe å¼¹å±‚
    function openNotionPage(task) {
      const url = task.notionUrl || "https://www.notion.so";
      const backdrop = document.getElementById("notionBackdrop");
      const frame = document.getElementById("notionFrame");
      backdrop.classList.add("open");
      try {
        frame.src = url;
      } catch (e) {
        window.open(url, "_blank");
      }
    }

    function initNotionOverlay() {
      const backdrop = document.getElementById("notionBackdrop");
      const closeBtn = document.getElementById("notionClose");
      const frame = document.getElementById("notionFrame");

      closeBtn.addEventListener("click", () => {
        backdrop.classList.remove("open");
        frame.src = "";
      });

      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) {
          backdrop.classList.remove("open");
          frame.src = "";
        }
      });
    }

    // Inbox æŠ½å±‰
    function initInboxSheet() {
      const sheet = document.getElementById("inboxSheet");
      const handle = document.getElementById("inboxHandle");
      let startY = 0;
      let dragging = false;

      function toggleSheet() {
        sheet.classList.toggle("expanded");
      }

      handle.addEventListener("click", () => {
        if (!dragging) toggleSheet();
      });

      handle.addEventListener("touchstart", (e) => {
        dragging = false;
        startY = e.touches[0].clientY;
      });

      handle.addEventListener("touchmove", (e) => {
        const dy = e.touches[0].clientY - startY;
        if (Math.abs(dy) > 10) dragging = true;
      });

      handle.addEventListener("touchend", (e) => {
        if (!dragging) return;
        const endY = e.changedTouches[0].clientY;
        const dy = endY - startY;
        if (dy > 20) {
          sheet.classList.remove("expanded");
        } else if (dy < -20) {
          sheet.classList.add("expanded");
        }
        dragging = false;
      });
    }

    // Tabs
    function initTabs() {
      const buttons = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll(".panel");

      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-tab");
          buttons.forEach(b => b.classList.remove("active"));
          panels.forEach(p => p.classList.remove("active"));
          btn.classList.add("active");
          document.querySelector(`.panel[data-panel="${target}"]`).classList.add("active");
        });
      });
    }

    // è§„åˆ’é˜Ÿåˆ—
    function buildPlannerQueue(overdueList, inboxList) {
      plannerQueue = [...overdueList, ...inboxList];
      plannerIndex = 0;
    }

    function openPlanner() {
      const backdrop = document.getElementById("plannerBackdrop");
      const content = document.getElementById("plannerContent");
      const progress = document.getElementById("plannerProgress");

      content.innerHTML = "";
      if (plannerQueue.length === 0) {
        progress.textContent = "";
        content.innerHTML = `<div class="planner-empty">å½“å‰æ²¡æœ‰éœ€è¦è§„åˆ’çš„é€¾æœŸæˆ– Inbox ä»»åŠ¡</div>`;
      } else {
        renderPlannerCard(content, progress);
      }

      backdrop.classList.add("open");
    }

    function createPlannerButton(icon, label, handler) {
      const btn = document.createElement("button");
      btn.className = "planner-btn";

      const iconSpan = document.createElement("span");
      iconSpan.className = "planner-btn-icon";
      iconSpan.textContent = icon;

      const textSpan = document.createElement("span");
      textSpan.textContent = label;

      btn.appendChild(iconSpan);
      btn.appendChild(textSpan);

      btn.addEventListener("click", handler);
      return btn;
    }

    function nextPlannerItem(content, progressEl) {
      plannerIndex++;
      renderPlannerCard(content, progressEl);
    }

    function renderPlannerCard(content, progressEl) {
      content.innerHTML = "";

      if (plannerIndex >= plannerQueue.length) {
        progressEl.textContent = "";
        content.innerHTML = `<div class="planner-empty">å·²å®Œæˆæœ¬è½®è§„åˆ’</div>`;
        return;
      }

      const task = plannerQueue[plannerIndex];
      progressEl.textContent = `${plannerIndex + 1} / ${plannerQueue.length}`;

      const card = document.createElement("div");
      card.className = "planner-card";

      const title = document.createElement("div");
      title.className = "planner-task-title";
      title.textContent = task.title || "(æœªå‘½åä»»åŠ¡)";

      const desc = document.createElement("div");
      desc.className = "planner-task-desc";
      desc.textContent = task.description || "â€”";

      const actions = document.createElement("div");
      actions.className = "planner-action-row";

      const btnToday = createPlannerButton("â˜€ï¸", "ä»Šå¤©", () => {
        task.date = todayStr();
        // æ›´æ–°æœ¬åœ° tasks
        tasks = tasks.map(t => t.id === task.id ? { ...t, date: task.date } : t);
        rebuildTaskMap();
        render(tasks);

        addPendingChange({
          type: "updateDate",
          id: task.id,
          date: task.date,
        });

        nextPlannerItem(content, progressEl);
      });

      const btnTomorrow = createPlannerButton("ğŸŒ¤", "æ˜å¤©", () => {
        task.date = offsetDateStr(1);
        tasks = tasks.map(t => t.id === task.id ? { ...t, date: task.date } : t);
        rebuildTaskMap();
        render(tasks);

        addPendingChange({
          type: "updateDate",
          id: task.id,
          date: task.date,
        });

        nextPlannerItem(content, progressEl);
      });

      const btnDate = createPlannerButton("ğŸ“…", "é€‰æ‹©æ—¥æœŸ", () => {
        const input = prompt("è¯·è¾“å…¥æ—¥æœŸ (YYYY-MM-DD)ï¼š", todayStr());
        if (!input) return;
        task.date = input;
        tasks = tasks.map(t => t.id === task.id ? { ...t, date: task.date } : t);
        rebuildTaskMap();
        render(tasks);

        addPendingChange({
          type: "updateDate",
          id: task.id,
          date: task.date,
        });

        nextPlannerItem(content, progressEl);
      });

      const btnSomeday = createPlannerButton("â³", "å¾…å®š", () => {
        task.date = null;
        tasks = tasks.map(t => t.id === task.id ? { ...t, date: null } : t);
        rebuildTaskMap();
        render(tasks);

        addPendingChange({
          type: "updateDate",
          id: task.id,
          date: null,
        });

        nextPlannerItem(content, progressEl);
      });

      actions.appendChild(btnToday);
      actions.appendChild(btnTomorrow);
      actions.appendChild(btnDate);
      actions.appendChild(btnSomeday);

      card.appendChild(title);
      card.appendChild(desc);
      card.appendChild(actions);

      content.appendChild(card);
    }

    function initPlanner() {
      const backdrop = document.getElementById("plannerBackdrop");
      const closeBtn = document.getElementById("plannerClose");
      const planFab = document.getElementById("planFab");

      planFab.addEventListener("click", () => {
        openPlanner();
      });

      closeBtn.addEventListener("click", () => {
        backdrop.classList.remove("open");
      });

      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) {
          backdrop.classList.remove("open");
        }
      });
    }

    // æ–°å»ºä»»åŠ¡å¼¹å±‚
    function openNewTaskModal() {
      document.getElementById("newTitle").value = "";
      document.getElementById("newDesc").value = "";
      document.getElementById("newDate").value = "";
      document.getElementById("newtaskBackdrop").classList.add("open");
    }

    function closeNewTaskModal() {
      document.getElementById("newtaskBackdrop").classList.remove("open");
    }

    function initNewTaskModal() {
      const backdrop = document.getElementById("newtaskBackdrop");
      const closeBtn = document.getElementById("newtaskClose");
      const cancelBtn = document.getElementById("newCancel");
      const saveBtn = document.getElementById("newSave");
      const addFab = document.getElementById("addFab");

      addFab.addEventListener("click", () => {
        openNewTaskModal();
      });

      closeBtn.addEventListener("click", () => {
        closeNewTaskModal();
      });

      cancelBtn.addEventListener("click", () => {
        closeNewTaskModal();
      });

      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closeNewTaskModal();
      });

      saveBtn.addEventListener("click", () => {
        const title = document.getElementById("newTitle").value.trim();
        const desc = document.getElementById("newDesc").value.trim();
        const date = document.getElementById("newDate").value.trim();

        if (!title) {
          alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©º");
          return;
        }

        const tempId = "local-" + Date.now();
        const newTask = {
          id: tempId,
          title: title,
          description: desc || null,
          date: date || null,
          status: "å¾…åŠ",
          notionUrl: "",
        };

        tasks.unshift(newTask);
        rebuildTaskMap();
        render(tasks);

        addPendingChange({
          type: "create",
          tempId: tempId,
          title: title,
          description: desc || null,
          date: date || null,
        });

        closeNewTaskModal();
      });
    }

    // æ ‡é¢˜æ åˆ·æ–°å°å­— & è®¾ç½®æŒ‰é’®
    function initHeaderControls() {
      refreshLabelEl = document.getElementById("refreshLabel");
      const settingsBtn = document.getElementById("settingsBtn");

      refreshLabelEl.addEventListener("click", () => {
        // æ‰‹åŠ¨åˆ·æ–°ï¼šé‡æ–°æ‹‰å–ä»»åŠ¡ + é‡è¯• pending
        loadTasksFromServer().then(() => {
          processPendingChanges();
        });
      });

      settingsBtn.addEventListener("click", () => {
        alert("è®¾ç½®é¢æ¿åŠŸèƒ½é¢„ç•™ï¼ˆå¦‚åç»­éœ€è¦å‰ç«¯é…ç½®ä»£ç†åœ°å€ç­‰ï¼‰");
      });

      updateSyncStatusUI();
    }

    document.addEventListener("DOMContentLoaded", () => {
      initHeaderDate();
      initTabs();
      initInboxSheet();
      initNotionOverlay();
      initPlanner();
      initNewTaskModal();
      initHeaderControls();

      // é¦–æ¬¡åŠ è½½æ•°æ® + å°è¯•åŒæ­¥ pending
      loadTasksFromServer().then(() => {
        processPendingChanges();
      });
    });
  </script>
</body>
</html>