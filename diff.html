<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/007AFF/ffffff?text=Diff">
    
    <title>Diff Tool</title>
    
    <!-- æ ¸å¿ƒåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <!-- æˆªå›¾åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- PDFåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text: #000000;
            --text-sec: #8E8E93;
            --border: #C6C6C8;
            --del-bg: #ffeef0; --del-color: #d70022;
            --ins-bg: #e6ffec; --ins-color: #2da44e;
            --nav-bg: rgba(255, 255, 255, 0.85);
            --header-border: rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --card-bg: #1C1C1E;
                --text: #FFFFFF;
                --text-sec: #98989D;
                --border: #38383A;
                --del-bg: #4c181d; --del-color: #ff7b72;
                --ins-bg: #153620; --ins-color: #7ee787;
                --nav-bg: rgba(28, 28, 30, 0.85);
                --header-border: rgba(255,255,255,0.15);
            }
        }

        html, body {
            touch-action: pan-x pan-y;
            overflow: hidden;
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text);
            display: flex; flex-direction: column;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            position: fixed; top: 0; left: 0; right: 0;
            padding: max(10px, env(safe-area-inset-top)) 15px 10px;
            text-align: center;
            font-weight: 600; font-size: 17px;
            z-index: 20;
            background: var(--nav-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--header-border);
            display: flex; justify-content: space-between; align-items: center;
        }

        .btn-icon {
            color: var(--primary); background: none; border: none;
            font-size: 22px; cursor: pointer; padding: 0 5px;
            display: flex; align-items: center; justify-content: center;
        }

        /* ä¸»åŒºåŸŸ */
        main {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: calc(60px + env(safe-area-inset-top)) 15px calc(100px + env(safe-area-inset-bottom));
        }

        /* è¾“å…¥æ¡† */
        #input-container { transition: opacity 0.3s ease; }
        #input-container.hidden { display: none; }
        .input-group { display: flex; flex-direction: column; gap: 20px; margin-bottom: 25px; }
        .label {
            font-size: 12px; color: var(--text-sec); margin-bottom: 8px; margin-left: 4px;
            text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;
        }
        textarea {
            width: 100%; height: 240px;
            border: 1px solid var(--border); border-radius: 12px;
            padding: 12px; font-size: 17px; line-height: 1.5;
            resize: none; background: var(--card-bg); color: var(--text);
            appearance: none; font-family: inherit;
        }
        textarea:focus { outline: none; border-color: var(--primary); }

        .btn-main {
            background-color: var(--primary); color: white;
            border: none; border-radius: 12px;
            padding: 16px; font-size: 17px; font-weight: 600;
            width: 100%; cursor: pointer;
        }

        /* ç»“æœåŒºåŸŸ */
        #result-wrapper { display: none; }
        #result-wrapper.show { display: block; animation: fadeIn 0.3s; }

        .result-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; background: var(--card-bg);
            padding: 10px; border-radius: 10px;
        }
        .stats { font-size: 13px; color: var(--text-sec); font-variant-numeric: tabular-nums; }
        
        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .segmented {
            display: flex; background: rgba(120, 120, 128, 0.12);
            padding: 2px; border-radius: 8px;
        }
        .seg-btn {
            padding: 4px 12px; font-size: 13px; border-radius: 6px;
            border: none; background: transparent; color: var(--text);
            cursor: pointer; font-weight: 500;
        }
        .seg-btn.active { background: var(--card-bg); box-shadow: 0 3px 8px rgba(0,0,0,0.12); }

        /* ç»“æœå®¹å™¨ */
        #result-container {
            background: var(--card-bg); border-radius: 12px;
            padding: 20px; min-height: 100px;
            line-height: 1.8; word-wrap: break-word; font-size: 17px;
        }
        /* æˆªå›¾æ—¶ç»™ä¸€ä¸ªå†…è¾¹è·ï¼Œé˜²æ­¢å­—è´´è¾¹ */
        .screenshot-mode { padding: 30px !important; border-radius: 0 !important; }

        del { background: var(--del-bg); color: var(--del-color); text-decoration: line-through; border-radius: 3px; }
        ins { background: var(--ins-bg); color: var(--ins-color); text-decoration: none; border-bottom: 2px solid; border-radius: 3px; }

        #edit-bar {
            background: var(--card-bg); color: var(--primary);
            padding: 12px; border-radius: 12px; text-align: center;
            font-weight: 600; font-size: 15px; margin-bottom: 20px;
            cursor: pointer; border: 1px solid var(--border);
        }

        /* æ‚¬æµ®å¯¼èˆª */
        #diff-nav-bar {
            position: fixed; bottom: max(20px, env(safe-area-inset-bottom));
            left: 50%; transform: translateX(-50%);
            background: var(--nav-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 8px 16px; border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none; align-items: center; gap: 15px; z-index: 100;
            border: 0.5px solid var(--header-border);
        }
        #diff-nav-bar.show { display: flex; }
        .nav-btn { background: transparent; border: none; font-size: 20px; color: var(--primary); display: flex; align-items: center; }
        .nav-counter { font-size: 15px; font-weight: 600; min-width: 40px; text-align: center; color: var(--text); }
        .active-change { outline: 2px solid var(--primary); outline-offset: 3px; border-radius: 3px; }

        /* Action Sheet (å¯¼å‡ºèœå•) */
        #action-sheet-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 200;
            opacity: 0; visibility: hidden; transition: all 0.3s;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        #action-sheet-overlay.show { opacity: 1; visibility: visible; }
        
        .action-sheet {
            background: #F2F2F7;
            border-top-left-radius: 12px; border-top-right-radius: 12px;
            padding: 10px 10px max(20px, env(safe-area-inset-bottom));
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @media (prefers-color-scheme: dark) { .action-sheet { background: #1C1C1E; } }
        #action-sheet-overlay.show .action-sheet { transform: translateY(0); }

        .action-btn {
            background: var(--card-bg); color: var(--primary);
            border: none; width: 100%; padding: 16px;
            font-size: 18px; font-weight: 500;
            border-radius: 12px; margin-bottom: 8px;
            cursor: pointer;
        }
        .action-btn.cancel { font-weight: 600; margin-top: 8px; margin-bottom: 0; }
        .action-btn:active { opacity: 0.7; transform: scale(0.99); }

        /* Loading æç¤º */
        #loading-toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 20px; border-radius: 12px; z-index: 300;
            display: none; text-align: center; font-weight: 600;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <button class="btn-icon" style="font-size: 16px;" onclick="clearAll()">æ¸…ç©º</button>
    <span>Diff Tool</span>
    <button class="btn-icon" onclick="openActionSheet()" id="btn-export" style="visibility: hidden;">
        <!-- å¯¼å‡ºå›¾æ ‡ -->
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
    </button>
</header>

<main>
    <div id="input-container">
        <div class="input-group">
            <div>
                <div class="label">åŸæ–‡ (Original)</div>
                <textarea id="oldText" placeholder="åœ¨æ­¤ç²˜è´´åŸæ–‡..."></textarea>
            </div>
            <div>
                <div class="label">æ–°æ–‡ (Modified)</div>
                <textarea id="newText" placeholder="åœ¨æ­¤ç²˜è´´æ–°æ–‡..."></textarea>
            </div>
        </div>
        <button class="btn-main" onclick="startCompare()">å¼€å§‹æ¯”è¾ƒ</button>
    </div>

    <div id="result-wrapper">
        <div id="edit-bar" onclick="toggleEditMode(true)">âœï¸ ä¿®æ”¹å†…å®¹</div>
        
        <div class="result-controls">
            <div class="stats" id="diff-stats">è®¡ç®—ä¸­...</div>
            <div class="segmented">
                <button class="seg-btn active" id="btn-word" onclick="switchMode('word')">è¯</button>
                <button class="seg-btn" id="btn-char" onclick="switchMode('char')">å­—</button>
            </div>
        </div>

        <div id="result-container"></div>
    </div>
</main>

<!-- æ‚¬æµ®å¯¼èˆª -->
<div id="diff-nav-bar">
    <button class="nav-btn" onclick="nav(-1)">â–²</button>
    <span class="nav-counter" id="nav-count">0/0</span>
    <button class="nav-btn" onclick="nav(1)">â–¼</button>
</div>

<!-- å¯¼å‡ºèœå• Action Sheet -->
<div id="action-sheet-overlay" onclick="closeActionSheet()">
    <div class="action-sheet" onclick="event.stopPropagation()">
        <button class="action-btn" onclick="exportImage()">ğŸ“¸ å¤åˆ¶é•¿æˆªå›¾</button>
        <button class="action-btn" onclick="exportPDF()">ğŸ“„ ä¿å­˜ä¸º PDF</button>
        <button class="action-btn cancel" onclick="closeActionSheet()">å–æ¶ˆ</button>
    </div>
</div>

<!-- Loading Toast -->
<div id="loading-toast">å¤„ç†ä¸­...</div>

<script>
    document.addEventListener('gesturestart', e => e.preventDefault());

    const els = {
        old: document.getElementById('oldText'),
        new: document.getElementById('newText'),
        inputBox: document.getElementById('input-container'),
        resWrapper: document.getElementById('result-wrapper'),
        resBox: document.getElementById('result-container'),
        navBar: document.getElementById('diff-nav-bar'),
        navCount: document.getElementById('nav-count'),
        stats: document.getElementById('diff-stats'),
        btnExport: document.getElementById('btn-export'),
        sheet: document.getElementById('action-sheet-overlay'),
        loading: document.getElementById('loading-toast')
    };

    let state = {
        mode: localStorage.getItem('diff_mode') || 'word',
        changes: [],
        idx: -1
    };

    updateModeBtn();

    function startCompare() {
        renderDiff();
        toggleEditMode(false);
    }

    function renderDiff() {
        if (typeof Diff === 'undefined') return alert("Diffåº“åŠ è½½å¤±è´¥");
        
        const oldStr = els.old.value;
        const newStr = els.new.value;
        const diffFn = state.mode === 'char' ? Diff.diffChars : Diff.diffWords;
        const diffData = diffFn(oldStr, newStr);

        const fragment = document.createDocumentFragment();
        let addCount = 0, delCount = 0;

        diffData.forEach(part => {
            const span = document.createElement(part.added ? 'ins' : part.removed ? 'del' : 'span');
            span.textContent = part.value;
            fragment.appendChild(span);
            if(part.added) addCount++;
            if(part.removed) delCount++;
        });

        els.resBox.innerHTML = '';
        els.resBox.appendChild(fragment);
        els.stats.textContent = `-${delCount} / +${addCount}`;
        
        initNav();
    }

    function switchMode(mode) {
        if (state.mode === mode) return;
        state.mode = mode;
        localStorage.setItem('diff_mode', mode);
        updateModeBtn();
        renderDiff();
    }

    function updateModeBtn() {
        document.getElementById('btn-word').className = state.mode === 'word' ? 'seg-btn active' : 'seg-btn';
        document.getElementById('btn-char').className = state.mode === 'char' ? 'seg-btn active' : 'seg-btn';
    }

    function initNav() {
        state.changes = els.resBox.querySelectorAll('ins, del');
        state.idx = -1;
        if (state.changes.length > 0) {
            els.navBar.classList.add('show');
            updateNavUI();
            nav(1);
        } else {
            els.navBar.classList.remove('show');
        }
    }

    function nav(step) {
        if (!state.changes.length) return;
        if (state.idx >= 0) state.changes[state.idx].classList.remove('active-change');
        state.idx += step;
        if (state.idx >= state.changes.length) state.idx = 0;
        if (state.idx < 0) state.idx = state.changes.length - 1;
        
        const el = state.changes[state.idx];
        el.classList.add('active-change');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        updateNavUI();
    }

    function updateNavUI() {
        els.navCount.textContent = `${state.idx + 1}/${state.changes.length}`;
    }

    function toggleEditMode(showInput) {
        if (showInput) {
            els.inputBox.classList.remove('hidden');
            els.resWrapper.classList.remove('show');
            els.navBar.classList.remove('show');
            els.btnExport.style.visibility = 'hidden';
        } else {
            els.inputBox.classList.add('hidden');
            els.resWrapper.classList.add('show');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            els.btnExport.style.visibility = 'visible';
        }
    }

    // --- å¯¼å‡ºåŠŸèƒ½ ---

    function openActionSheet() { els.sheet.classList.add('show'); }
    function closeActionSheet() { els.sheet.classList.remove('show'); }
    function showLoading() { els.loading.style.display = 'block'; }
    function hideLoading() { els.loading.style.display = 'none'; }

    // é€šç”¨æˆªå›¾ç”Ÿæˆå™¨
    async function generateCanvas() {
        showLoading();
        closeActionSheet();

        // ä¸´æ—¶æ ·å¼è°ƒæ•´ä»¥ä¼˜åŒ–æˆªå›¾æ•ˆæœ
        const target = els.resBox;
        const originalStyle = target.getAttribute('style');
        
        // å¼ºåˆ¶èƒŒæ™¯è‰²ï¼Œé˜²æ­¢é€æ˜
        const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        target.style.backgroundColor = isDark ? '#1C1C1E' : '#FFFFFF';
        target.style.color = isDark ? '#FFFFFF' : '#000000';
        target.classList.add('screenshot-mode'); // å¢åŠ å†…è¾¹è·

        try {
            const canvas = await html2canvas(target, {
                scale: 2, // æé«˜æ¸…æ™°åº¦
                useCORS: true,
                backgroundColor: isDark ? '#1C1C1E' : '#FFFFFF',
                windowWidth: target.scrollWidth,
                windowHeight: target.scrollHeight
            });
            
            // æ¢å¤æ ·å¼
            target.classList.remove('screenshot-mode');
            target.setAttribute('style', originalStyle || '');
            
            return canvas;
        } catch (e) {
            alert('ç”Ÿæˆæˆªå›¾å¤±è´¥: ' + e.message);
            hideLoading();
            return null;
        }
    }

    async function exportImage() {
        if (!navigator.clipboard || !navigator.clipboard.write) {
            alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥å†™å…¥å‰ªè´´æ¿ï¼Œè¯·ä½¿ç”¨PDFå¯¼å‡ºåŠŸèƒ½ã€‚");
            return;
        }

        const canvas = await generateCanvas();
        if (!canvas) return;

        canvas.toBlob(async (blob) => {
            try {
                // å†™å…¥å‰ªè´´æ¿
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                alert("âœ… é•¿æˆªå›¾å·²å¤åˆ¶ï¼\næ‚¨å¯ä»¥ç›´æ¥ç²˜è´´åˆ°å¾®ä¿¡æˆ–å¤‡å¿˜å½•ã€‚");
            } catch (err) {
                console.error(err);
                alert("å¤åˆ¶å¤±è´¥ã€‚è¯·å°è¯•ä½¿ç”¨PDFä¿å­˜ã€‚");
            } finally {
                hideLoading();
            }
        }, 'image/png');
    }

    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const canvas = await generateCanvas();
        if (!canvas) return;

        try {
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;

            // åˆ›å»ºPDFï¼Œé¡µé¢å¤§å°è®¾ä¸ºå›¾ç‰‡å¤§å° (å•ä½: pt)
            // 0.75 æ˜¯ px åˆ° pt çš„è½¬æ¢æ¯”ä¾‹
            const pdf = new jsPDF({
                orientation: imgWidth > imgHeight ? 'l' : 'p',
                unit: 'px',
                format: [imgWidth, imgHeight] 
            });

            pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
            pdf.save('Diff_Result.pdf');
        } catch (e) {
            console.error(e);
            alert("PDFç”Ÿæˆå¤±è´¥");
        } finally {
            hideLoading();
        }
    }

    function clearAll() {
        if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")) {
            els.old.value = ''; els.new.value = '';
            localStorage.removeItem('diff_old'); localStorage.removeItem('diff_new');
            toggleEditMode(true);
        }
    }

    window.addEventListener('load', () => {
        const sOld = localStorage.getItem('diff_old');
        const sNew = localStorage.getItem('diff_new');
        if (sOld) els.old.value = sOld;
        if (sNew) els.new.value = sNew;
    });
    els.old.addEventListener('input', () => localStorage.setItem('diff_old', els.old.value));
    els.new.addEventListener('input', () => localStorage.setItem('diff_new', els.new.value));
</script>
</body>
</html>