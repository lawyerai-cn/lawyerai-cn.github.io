<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/007AFF/ffffff?text=Diff">
    
    <title>Diff Tool</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text: #000000;
            --text-sec: #8E8E93;
            --border: #C6C6C8;
            --del-bg: #ffeef0; --del-color: #d70022;
            --ins-bg: #e6ffec; --ins-color: #2da44e;
            --nav-bg: rgba(255, 255, 255, 0.85);
            --header-border: rgba(0,0,0,0.1);
            --search-highlight: #ffeb3b;
            --search-current: #ff9800;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --card-bg: #1C1C1E;
                --text: #FFFFFF;
                --text-sec: #98989D;
                --border: #38383A;
                --del-bg: #4c181d; --del-color: #ff7b72;
                --ins-bg: #153620; --ins-color: #7ee787;
                --nav-bg: rgba(28, 28, 30, 0.85);
                --header-border: rgba(255,255,255,0.15);
                --search-highlight: #665c00;
                --search-current: #995c00;
            }
        }

        html, body { touch-action: pan-x pan-y; overflow: hidden; height: 100%; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column;
        }

        header {
            position: fixed; top: 0; left: 0; right: 0;
            padding: max(10px, env(safe-area-inset-top)) 15px 10px;
            text-align: center; font-weight: 600; font-size: 17px;
            z-index: 20; background: var(--nav-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--header-border);
            display: flex; justify-content: space-between; align-items: center;
        }

        .btn-icon {
            color: var(--primary); background: none; border: none;
            font-size: 22px; cursor: pointer; padding: 0 5px;
            display: flex; align-items: center; justify-content: center;
        }

        main {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: calc(60px + env(safe-area-inset-top)) 15px calc(100px + env(safe-area-inset-bottom));
        }

        #input-container { transition: opacity 0.3s ease; }
        #input-container.hidden { display: none; }
        .input-group { display: flex; flex-direction: column; gap: 20px; margin-bottom: 25px; }
        .label {
            font-size: 12px; color: var(--text-sec); margin-bottom: 8px; margin-left: 4px;
            text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;
        }
        textarea {
            width: 100%; height: 240px;
            border: 1px solid var(--border); border-radius: 12px;
            padding: 12px; font-size: 17px; line-height: 1.5;
            resize: none; background: var(--card-bg); color: var(--text);
            appearance: none; font-family: inherit;
        }
        textarea:focus { outline: none; border-color: var(--primary); }
        .btn-main {
            background-color: var(--primary); color: white;
            border: none; border-radius: 12px;
            padding: 16px; font-size: 17px; font-weight: 600;
            width: 100%; cursor: pointer;
        }

        #result-wrapper { display: none; }
        #result-wrapper.show { display: block; animation: fadeIn 0.3s; }

        /* 工具栏 */
        .result-controls {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg);
            padding: 10px; border-radius: 10px; gap: 10px;
            /* 保持在搜索框上方 */
            position: relative; z-index: 2;
        }
        
        .controls-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        .controls-right { display: flex; align-items: center; gap: 8px; }

        .stats { font-size: 13px; color: var(--text-sec); font-variant-numeric: tabular-nums; white-space: nowrap; }

        /* 搜索框 (位于工具栏下方) */
        #search-bar {
            background: var(--card-bg); 
            padding: 8px; border-radius: 10px;
            margin-top: 10px; /* 与上方工具栏的间距 */
            display: none; 
            align-items: center; gap: 5px;
            border: 1px solid var(--primary);
            animation: slideDown 0.2s ease-out;
        }
        #search-bar.show { display: flex; }
        
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .search-input {
            flex: 1; border: none; background: transparent; font-size: 16px; color: var(--text);
            padding: 8px; 
        }
        .search-input:focus { outline: none; }
        
        /* 加大的搜索前后按钮 */
        .search-btn {
            background: rgba(120, 120, 128, 0.1); 
            border: none; border-radius: 8px;
            color: var(--primary);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            width: 44px; height: 40px; /* 加大触控区域 */
            font-size: 20px;
            transition: background 0.2s;
        }
        .search-btn:active { background: rgba(120, 120, 128, 0.2); }
        
        .search-counter {
            font-size: 13px; color: var(--text-sec); font-variant-numeric: tabular-nums;
            min-width: 45px; text-align: center;
        }

        /* 按钮样式 */
        .icon-btn {
            background: rgba(120, 120, 128, 0.12);
            border: none; border-radius: 8px;
            width: 34px; height: 34px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text); cursor: pointer;
            transition: all 0.2s;
        }
        .icon-btn.active { background: var(--primary); color: white; }
        
        .btn-toggle-punct {
            background: rgba(120, 120, 128, 0.12);
            border: none; border-radius: 8px;
            padding: 6px 10px; font-size: 13px; font-weight: 500;
            color: var(--text); cursor: pointer;
            display: flex; align-items: center; gap: 4px;
        }
        .btn-toggle-punct.active { background: var(--primary); color: white; }

        .segmented {
            display: flex; background: rgba(120, 120, 128, 0.12);
            padding: 2px; border-radius: 8px;
        }
        .seg-btn {
            padding: 4px 10px; font-size: 13px; border-radius: 6px;
            border: none; background: transparent; color: var(--text);
            cursor: pointer; font-weight: 500;
        }
        .seg-btn.active { background: var(--card-bg); box-shadow: 0 3px 8px rgba(0,0,0,0.12); color: var(--text); }

        #result-container {
            background: var(--card-bg); border-radius: 12px;
            padding: 20px; min-height: 100px; margin-top: 15px;
            line-height: 1.8; word-wrap: break-word; font-size: 17px;
        }
        .screenshot-mode { padding: 30px !important; border-radius: 0 !important; }

        del { background: var(--del-bg); color: var(--del-color); text-decoration: line-through; border-radius: 3px; }
        ins { background: var(--ins-bg); color: var(--ins-color); text-decoration: none; border-bottom: 2px solid; border-radius: 3px; }
        
        mark.search-match { background-color: var(--search-highlight); color: black; border-radius: 2px; padding: 0 1px; }
        mark.search-match.current { background-color: var(--search-current); color: white; outline: 2px solid var(--primary); outline-offset: 1px; }

        #edit-bar {
            background: var(--card-bg); color: var(--primary);
            padding: 12px; border-radius: 12px; text-align: center;
            font-weight: 600; font-size: 15px; margin-bottom: 15px;
            cursor: pointer; border: 1px solid var(--border);
        }

        #diff-nav-bar {
            position: fixed; bottom: max(20px, env(safe-area-inset-bottom));
            left: 50%; transform: translateX(-50%);
            background: var(--nav-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 8px 16px; border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none; align-items: center; gap: 15px; z-index: 100;
            border: 0.5px solid var(--header-border);
        }
        #diff-nav-bar.show { display: flex; }
        .nav-btn { background: transparent; border: none; font-size: 20px; color: var(--primary); display: flex; align-items: center; }
        .nav-counter { font-size: 15px; font-weight: 600; min-width: 40px; text-align: center; color: var(--text); }
        .active-change { outline: 2px solid var(--primary); outline-offset: 3px; border-radius: 3px; }
        
        #loading-toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 20px; border-radius: 12px; z-index: 300;
            display: none; text-align: center; font-weight: 600;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <button class="btn-icon" style="font-size: 16px;" onclick="clearAll()">清空</button>
    <span>Diff Tool</span>
    <!-- 点击直接导出 PDF -->
    <button class="btn-icon" onclick="exportPDF()" id="btn-export" style="visibility: hidden;" title="导出PDF">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
    </button>
</header>

<main>
    <div id="input-container">
        <div class="input-group">
            <div>
                <div class="label">原文 (Original)</div>
                <textarea id="oldText" placeholder="在此粘贴原文..."></textarea>
            </div>
            <div>
                <div class="label">新文 (Modified)</div>
                <textarea id="newText" placeholder="在此粘贴新文..."></textarea>
            </div>
        </div>
        <button class="btn-main" onclick="startCompare()">开始比较</button>
    </div>

    <div id="result-wrapper">
        <div id="edit-bar" onclick="toggleEditMode(true)">✏️ 修改内容</div>
        
        <!-- 工具栏 -->
        <div class="result-controls">
            <div class="controls-left">
                <!-- 搜索开关图标 -->
                <button class="icon-btn" id="btn-search-toggle" onclick="toggleSearch()" title="搜索">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
                <div class="stats" id="diff-stats">...</div>
            </div>
            
            <div class="controls-right">
                <button id="btn-ignore-punct" class="btn-toggle-punct" onclick="togglePunctuation()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
                    忽略标点
                </button>
                <div class="segmented">
                    <button class="seg-btn active" id="btn-word" onclick="switchMode('word')">词</button>
                    <button class="seg-btn" id="btn-char" onclick="switchMode('char')">字</button>
                </div>
            </div>
        </div>

        <!-- 搜索栏 (位于工具栏下方) -->
        <div id="search-bar">
            <input type="text" class="search-input" id="search-input" placeholder="查找内容..." oninput="performSearch()">
            <span class="search-counter" id="search-counter">0/0</span>
            <button class="search-btn" onclick="navSearch(-1)">▲</button>
            <button class="search-btn" onclick="navSearch(1)">▼</button>
        </div>

        <div id="result-container"></div>
    </div>
</main>

<div id="diff-nav-bar">
    <button class="nav-btn" onclick="navDiff(-1)">▲</button>
    <span class="nav-counter" id="nav-count">0/0</span>
    <button class="nav-btn" onclick="navDiff(1)">▼</button>
</div>

<div id="loading-toast">处理中...</div>

<script>
    document.addEventListener('gesturestart', e => e.preventDefault());

    const els = {
        old: document.getElementById('oldText'),
        new: document.getElementById('newText'),
        inputBox: document.getElementById('input-container'),
        resWrapper: document.getElementById('result-wrapper'),
        resBox: document.getElementById('result-container'),
        navBar: document.getElementById('diff-nav-bar'),
        navCount: document.getElementById('nav-count'),
        stats: document.getElementById('diff-stats'),
        btnExport: document.getElementById('btn-export'),
        loading: document.getElementById('loading-toast'),
        btnIgnore: document.getElementById('btn-ignore-punct'),
        searchBar: document.getElementById('search-bar'),
        searchInput: document.getElementById('search-input'),
        searchCounter: document.getElementById('search-counter'),
        btnSearchToggle: document.getElementById('btn-search-toggle')
    };

    let state = {
        mode: localStorage.getItem('diff_mode') || 'word',
        ignorePunct: false,
        changes: [],
        changeIdx: -1,
        searchMatches: [],
        searchIdx: -1
    };

    updateModeBtn();

    function startCompare() {
        renderDiff();
        toggleEditMode(false);
    }

    function isPunctuationOrSpace(str) {
        try { return /^[\s\p{P}\p{S}]+$/u.test(str); } 
        catch (e) { return /^[\s.,\/#!$%\^&\*;:{}=\-_`~()？。，、；：‘’“”'"\[\]]+$/.test(str); }
    }

    function renderDiff() {
        if (typeof Diff === 'undefined') return alert("Diff库加载失败");
        
        closeSearch(); 

        const oldStr = els.old.value;
        const newStr = els.new.value;
        const diffFn = state.mode === 'char' ? Diff.diffChars : Diff.diffWords;
        const diffData = diffFn(oldStr, newStr);

        const fragment = document.createDocumentFragment();
        let addCount = 0, delCount = 0;

        diffData.forEach(part => {
            let isPunct = false;
            if (state.ignorePunct && (part.added || part.removed)) {
                if (isPunctuationOrSpace(part.value)) isPunct = true;
            }

            if (isPunct) {
                if (part.removed) return; 
                if (part.added) {
                    const span = document.createElement('span');
                    span.textContent = part.value;
                    fragment.appendChild(span);
                    return; 
                }
            }

            const span = document.createElement(part.added ? 'ins' : part.removed ? 'del' : 'span');
            span.textContent = part.value;
            fragment.appendChild(span);

            if(part.added) addCount++;
            if(part.removed) delCount++;
        });

        els.resBox.innerHTML = '';
        els.resBox.appendChild(fragment);
        els.stats.textContent = `-${delCount} / +${addCount}`;
        
        initDiffNav();
    }

    // --- 搜索功能 ---
    function toggleSearch() {
        const isShown = els.searchBar.classList.contains('show');
        if (isShown) {
            closeSearch();
        } else {
            els.searchBar.classList.add('show');
            els.btnSearchToggle.classList.add('active'); // 图标高亮
            els.searchInput.focus();
        }
    }

    function closeSearch() {
        els.searchBar.classList.remove('show');
        els.btnSearchToggle.classList.remove('active');
        els.searchInput.value = '';
        clearSearchHighlights();
    }

    function clearSearchHighlights() {
        const marks = els.resBox.querySelectorAll('mark.search-match');
        marks.forEach(mark => {
            const text = document.createTextNode(mark.textContent);
            mark.parentNode.replaceChild(text, mark);
        });
        els.resBox.normalize();
        state.searchMatches = [];
        state.searchIdx = -1;
        updateSearchUI();
    }

    function performSearch() {
        const query = els.searchInput.value;
        clearSearchHighlights();

        if (!query) return;

        const walker = document.createTreeWalker(els.resBox, NodeFilter.SHOW_TEXT, null, false);
        const textNodes = [];
        let node;
        while(node = walker.nextNode()) textNodes.push(node);
        
        textNodes.forEach(textNode => {
            const text = textNode.nodeValue;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            
            if (regex.test(text)) {
                const fragment = document.createDocumentFragment();
                let lastIdx = 0;
                text.replace(regex, (match, p1, offset) => {
                    fragment.appendChild(document.createTextNode(text.slice(lastIdx, offset)));
                    const mark = document.createElement('mark');
                    mark.className = 'search-match';
                    mark.textContent = match;
                    fragment.appendChild(mark);
                    lastIdx = offset + match.length;
                });
                fragment.appendChild(document.createTextNode(text.slice(lastIdx)));
                textNode.parentNode.replaceChild(fragment, textNode);
            }
        });

        state.searchMatches = els.resBox.querySelectorAll('mark.search-match');
        if (state.searchMatches.length > 0) navSearch(1);
        else updateSearchUI();
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function navSearch(step) {
        if (!state.searchMatches.length) return;
        
        if (state.searchIdx >= 0) state.searchMatches[state.searchIdx].classList.remove('current');

        state.searchIdx += step;
        if (state.searchIdx >= state.searchMatches.length) state.searchIdx = 0;
        if (state.searchIdx < 0) state.searchIdx = state.searchMatches.length - 1;

        const el = state.searchMatches[state.searchIdx];
        el.classList.add('current');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        updateSearchUI();
    }

    function updateSearchUI() {
        els.searchCounter.textContent = state.searchMatches.length === 0 ? "0/0" : `${state.searchIdx + 1}/${state.searchMatches.length}`;
    }

    // --- 其他逻辑 ---

    function togglePunctuation() {
        state.ignorePunct = !state.ignorePunct;
        els.btnIgnore.classList.toggle('active', state.ignorePunct);
        renderDiff();
    }

    function switchMode(mode) {
        if (state.mode === mode) return;
        state.mode = mode;
        localStorage.setItem('diff_mode', mode);
        updateModeBtn();
        renderDiff();
    }

    function updateModeBtn() {
        document.getElementById('btn-word').className = state.mode === 'word' ? 'seg-btn active' : 'seg-btn';
        document.getElementById('btn-char').className = state.mode === 'char' ? 'seg-btn active' : 'seg-btn';
    }

    function initDiffNav() {
        state.changes = els.resBox.querySelectorAll('ins, del');
        state.changeIdx = -1;
        if (state.changes.length > 0) {
            els.navBar.classList.add('show');
            updateDiffNavUI();
            navDiff(1);
        } else {
            els.navBar.classList.remove('show');
        }
    }

    function navDiff(step) {
        if (!state.changes.length) return;
        if (state.changeIdx >= 0) state.changes[state.changeIdx].classList.remove('active-change');
        state.changeIdx += step;
        if (state.changeIdx >= state.changes.length) state.changeIdx = 0;
        if (state.changeIdx < 0) state.changeIdx = state.changes.length - 1;
        
        const el = state.changes[state.changeIdx];
        el.classList.add('active-change');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        updateDiffNavUI();
    }

    function updateDiffNavUI() {
        els.navCount.textContent = `${state.changeIdx + 1}/${state.changes.length}`;
    }

    function toggleEditMode(showInput) {
        if (showInput) {
            els.inputBox.classList.remove('hidden');
            els.resWrapper.classList.remove('show');
            els.navBar.classList.remove('show');
            els.btnExport.style.visibility = 'hidden';
            closeSearch();
        } else {
            els.inputBox.classList.add('hidden');
            els.resWrapper.classList.add('show');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            els.btnExport.style.visibility = 'visible';
        }
    }

    function showLoading() { els.loading.style.display = 'block'; }
    function hideLoading() { els.loading.style.display = 'none'; }

    async function exportPDF() {
        showLoading();
        // 临时清理掉搜索高亮，以免印到PDF里
        clearSearchHighlights();
        // 关闭搜索框，保证PDF干净
        if (els.searchBar.classList.contains('show')) {
            closeSearch();
        }

        const target = els.resBox;
        const originalStyle = target.getAttribute('style');
        const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        target.style.backgroundColor = isDark ? '#1C1C1E' : '#FFFFFF';
        target.style.color = isDark ? '#FFFFFF' : '#000000';
        target.classList.add('screenshot-mode');

        try {
            const canvas = await html2canvas(target, {
                scale: 2, useCORS: true,
                backgroundColor: isDark ? '#1C1C1E' : '#FFFFFF',
                windowWidth: target.scrollWidth, windowHeight: target.scrollHeight
            });
            
            const { jsPDF } = window.jspdf;
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const pdf = new jsPDF({
                orientation: canvas.width > canvas.height ? 'l' : 'p',
                unit: 'px', format: [canvas.width, canvas.height] 
            });
            pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
            pdf.save('Diff_Result.pdf');
        } catch (e) {
            alert("PDF生成失败: " + e.message);
        } finally {
            target.classList.remove('screenshot-mode');
            target.setAttribute('style', originalStyle || '');
            hideLoading();
        }
    }

    function clearAll() {
        if(confirm("确定清空？")) {
            els.old.value = ''; els.new.value = '';
            localStorage.removeItem('diff_old'); localStorage.removeItem('diff_new');
            toggleEditMode(true);
        }
    }

    window.addEventListener('load', () => {
        const sOld = localStorage.getItem('diff_old');
        const sNew = localStorage.getItem('diff_new');
        if (sOld) els.old.value = sOld;
        if (sNew) els.new.value = sNew;
    });
    els.old.addEventListener('input', () => localStorage.setItem('diff_old', els.old.value));
    els.new.addEventListener('input', () => localStorage.setItem('diff_new', els.new.value));
</script>
</body>
</html>