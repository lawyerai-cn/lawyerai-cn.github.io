<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1, minimum-scale=1" />
  <title>FitCare æœˆåº¦å¥åº·ç®¡ç† | Mobile Demo</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --accent:#2563eb;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}
    html, body{
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
      touch-action: manipulation;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", Arial;
      background: linear-gradient(180deg, #eef2ff 0%, var(--bg) 40%);
      color:var(--text);
      width: 100%;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
    }
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 18px 16px 120px;
      width: 100%;
      height: auto;
      min-height: 100%;
    }
    .topbar{
      position: sticky;
      top: 0;
      z-index: 60;
      padding: 12px 16px 10px;
      background: linear-gradient(180deg, rgba(238,242,255,.92) 0%, rgba(246,247,251,.86) 70%, rgba(246,247,251,0) 100%);
      backdrop-filter: blur(10px);
      margin: 0 -16px;
      width: calc(100% + 32px);
    }
    .brand{display:flex;align-items:center;gap:10px;margin:2px 2px 10px}
    .logo{
      width: 40px;height:40px;border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, #93c5fd 0%, #2563eb 55%, #1e40af 100%);
      box-shadow: 0 10px 24px rgba(37,99,235,.25);
      position: relative; overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute;inset:-40%;
      background: conic-gradient(from 190deg, rgba(255,255,255,.75), rgba(255,255,255,0), rgba(255,255,255,.45), rgba(255,255,255,0));
      animation: spin 5s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .brand h1{font-size:16px;margin:0;line-height:1.1;letter-spacing:.2px}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 2px 0}
    .pill{
      display:flex;align-items:center;gap:8px;
      padding: 8px 10px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(255,255,255,.7);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      cursor: default;
      user-select:none;
    }
    .pill.clickable{cursor:pointer}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    .card{
      background: var(--card);
      border: 1px solid rgba(226,232,240,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin:0 0 8px;
      font-size: 14px;
      letter-spacing:.2px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .sub{font-size:12px;color:var(--muted);margin:0 0 10px;line-height:1.5}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .kpis{display:grid;grid-template-columns: repeat(3, 1fr);gap:10px;margin-top: 10px}
    .kpi{
      padding: 10px;
      border-radius: 14px;
      background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
      border: 1px solid rgba(226,232,240,.9);
    }
    .kpi .v{font-size:16px;font-weight:700;margin:2px 0}
    .kpi .l{font-size:11px;color:var(--muted)}
    .badge{
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      background: rgba(37,99,235,.08);
      color: var(--accent);
      border: 1px solid rgba(37,99,235,.18);
      white-space: nowrap;
    }
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border:none;border-radius:12px;padding:10px 12px;
      font-size:13px;font-weight:650;
      background: var(--accent); color:#fff;
      box-shadow: 0 10px 20px rgba(37,99,235,.18);
      cursor:pointer;
    }
    .btn.secondary{
      background:#fff;color:var(--text);
      border: 1px solid rgba(226,232,240,.95);
      box-shadow:none;
    }
    .btn.ghost{
      background:transparent;color:var(--accent);
      border: 1px dashed rgba(37,99,235,.35);
      box-shadow:none;
    }
    .btn:active{transform:translateY(1px)}
    .progress{height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden;margin-top:8px}
    .bar{
      height:100%;width:0%;
      background: linear-gradient(90deg, #60a5fa 0%, #2563eb 50%, #1e40af 100%);
      border-radius:999px;transition:width .25s ease;
    }
    .mini{font-size:12px;color:var(--muted);margin-top:8px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{
      border: 1px solid rgba(226,232,240,.95);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      margin-bottom: 4px;
    }
    .item .t{font-size:13px;font-weight:650;margin:0 0 6px}
    .item .m{font-size:12px;color:var(--muted);margin:0;line-height:1.5}
    .hr{height:1px;background:var(--line);margin: 10px 0}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .field label{font-size:12px;color:var(--muted)}
    input, textarea, select{
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(226,232,240,.95);
      outline:none;
      font-size: 13px;
      background:#fff;
    }
    textarea{min-height: 92px; resize: vertical}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 360px){
      .two{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr}
    }
    .tabs{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,.92);
      border-top: 1px solid rgba(226,232,240,.95);
      backdrop-filter: blur(10px);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      display:flex;justify-content:space-around;gap:8px;
      z-index: 90;
    }
    .tab{
      flex:1;border-radius:14px;padding:10px 8px;text-align:center;
      font-size:11px;color:var(--muted);
      border: 1px solid transparent; cursor:pointer; user-select:none;
    }
    .tab.active{
      background: rgba(37,99,235,.08);
      color: var(--accent);
      border-color: rgba(37,99,235,.18);
      font-weight: 700;
    }
    .hidden{display:none!important}
    .overlay:not(.hidden){opacity:1;transition:opacity .2s ease}
    .overlay.hidden{pointer-events:none}
    .hint{
      font-size:12px;color:var(--muted);line-height:1.5;
      background:#f8fafc;border:1px solid rgba(226,232,240,.95);
      border-radius:14px;padding:10px;
    }

    /* Floating action buttons - unified style */
    .float-btn{
      position: fixed;
      right: 16px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,.12);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 94;
      cursor: pointer;
      user-select: none;
      font-size: 28px;
      font-weight: 900;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      background: rgba(255,255,255,.05);
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
      padding: 0;
      backdrop-filter: blur(4px);
    }
    .float-btn:hover{
      transform: translateY(-6px);
      box-shadow: 0 8px 20px rgba(0,0,0,.15);
      background: rgba(255,255,255,.1);
    }
    .float-btn:active{
      transform: scale(0.95) translateY(-3px);
    }
    
    /* Coach button */
    .float-btn.coach{
      bottom: 220px;
      z-index: 95;
    }
    
    /* Workout checkin button */
    .float-btn.workout{
      bottom: 160px;
    }
    
    /* Meal checkin button */
    .float-btn.meal{
      bottom: 100px;
    }

    /* Modal & Drawer */
    .overlay{
      position: fixed; inset: 0;
      background: rgba(2,6,23,.45);
      z-index: 120;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
    }
    .sheet{
      width: min(520px, 100%);
      background:#fff;
      border-radius: 18px;
      border: 1px solid rgba(226,232,240,.95);
      box-shadow: 0 20px 60px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .sheet-head{
      padding: 12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom: 1px solid rgba(226,232,240,.95);
    }
    .sheet-title{font-weight: 800}
    .closebtn{
      border: 1px solid rgba(226,232,240,.95);
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .sheet-body{padding: 14px; max-height: 70vh; overflow:auto}
    .sheet-actions{
      padding: 12px 14px;
      border-top: 1px solid rgba(226,232,240,.95);
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
    }

    /* Image cards */
    .photo-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .photo{
      border-radius: 14px;
      border: 1px solid rgba(226,232,240,.95);
      overflow:hidden;
      background:#fff;
      aspect-ratio: 1 / 1;
      display:flex;align-items:center;justify-content:center;
      position: relative;
    }
    .photo img{width:100%;height:100%;object-fit:cover}
    .photo small{
      position:absolute;left:8px;bottom:8px;
      background: rgba(15,23,42,.72);
      color:#fff;
      padding: 4px 6px;
      border-radius: 10px;
      font-size: 10px;
    }

    /* Editable plan block */
    .editable{
      border: 1px solid rgba(226,232,240,.95);
      border-radius: 14px;
      padding: 10px 12px;
      background:#fff;
      line-height:1.55;
      font-size: 13px;
      white-space: pre-wrap;
      outline: none;
    }
    .editable:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.08);
    }

    .tagline{
      font-size:11px;color:var(--muted);
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>FitCare æœˆåº¦å¥åº·ç®¡ç†ï¼ˆDemoï¼‰</h1>
          <p>ç»Ÿä¸€ç•Œé¢ï¼šæ€»è§ˆ / å¥èº«æ–¹æ¡ˆ / è¥å…»è®¡åˆ’ / å¤ç›˜å¥–åŠ±</p>
        </div>
      </div>

      <div class="pillrow">
        <div class="pill"><span class="dot" id="statusDot"></span><span id="serviceStatus">æœåŠ¡ä¸­</span></div>
        <div class="pill"><span>æœ¬æœˆï¼š</span><b id="monthLabel"></b></div>
        <div class="pill clickable" id="coachPill" title="ç‚¹å‡»æ‰“å¼€æ•™ç»ƒä¿¡æ¯ä¸åé¦ˆ">
          <span>ä¸“å±æ•™ç»ƒï¼š</span><b id="coachName"></b><span style="color:var(--muted)">â€º</span>
        </div>
      </div>
    </div>

    <!-- æ€»è§ˆ -->
    <section id="view-home" class="grid">
      <!-- ç”¨æˆ·æ¦‚è§ˆï¼šä¿æŒåŸæ¥ä¸å˜ï¼ˆä¸°å¯Œåº¦ä¿æŒï¼‰ -->
      <div class="card">
        <h2>
          <span>ç”¨æˆ·æ¦‚è§ˆ</span>
          <span class="badge" id="planNameBadge">æ ‡å‡†ç‰ˆ Â· æœˆåº¦è®¢é˜…</span>
        </h2>
        <p class="sub" id="userLine">â€”</p>

        <div class="kpis">
          <div class="kpi">
            <div class="l">ä½“è„‚ç‡</div>
            <div class="v" id="kpiBfp">â€”</div>
            <div class="l">åŸºçº¿</div>
          </div>
          <div class="kpi">
            <div class="l">æœ¬å‘¨è®­ç»ƒå®Œæˆ</div>
            <div class="v" id="kpiWorkout">0/0</div>
            <div class="l">è®¡åˆ’æ¬¡æ•°</div>
          </div>
          <div class="kpi">
            <div class="l">é¥®é£Ÿæ‰§è¡Œ</div>
            <div class="v" id="kpiDiet">â€”</div>
            <div class="l">æœ¬å‘¨è‡ªè¯„</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div>
            <div style="font-size:12px;color:var(--muted)">æœˆåº¦ç›®æ ‡è¿›åº¦</div>
            <div style="font-weight:750;font-size:14px;margin-top:2px" id="goalTitle">â€”</div>
          </div>
          <div class="badge" id="goalStatus">è¿›è¡Œä¸­</div>
        </div>
        <div class="progress"><div class="bar" id="goalBar"></div></div>
        <div class="mini">
          <span id="goalProgressText">â€”</span>
          <span id="goalDueText">â€”</span>
        </div>

        <div class="btnrow">
          <button class="btn" onclick="go('plan')">è¿›å…¥å¥èº«æ–¹æ¡ˆ</button>
          <button class="btn secondary" onclick="go('nutrition')">è¿›å…¥è¥å…»è®¡åˆ’</button>
          <button class="btn ghost" onclick="go('review')">æŸ¥çœ‹å¤ç›˜å¥–åŠ±</button>
        </div>
      </div>

      <!-- æœ¬å‘¨è¯¾ç¨‹ï¼ˆå«é¢„çº¦çŠ¶æ€ä¸è·³è½¬é“¾æ¥æŒ‰é’®ï¼‰ -->
      <div class="card">
        <h2><span>æœ¬å‘¨è¯¾ç¨‹</span><span class="badge">é¢„çº¦è·³è½¬</span></h2>
        <p class="sub">å±•ç¤ºæœ¬å‘¨é¢„çº¦çŠ¶æ€ï¼›ç‚¹å‡»â€œå»é¢„çº¦/æŸ¥çœ‹â€å°†è·³è½¬åˆ°ç¬¬ä¸‰æ–¹é¢„çº¦ç³»ç»Ÿã€‚</p>
        <div class="list" id="weekClassList"></div>
      </div>

      <!-- ä»Šæ—¥é¥®é£Ÿè§„åˆ’ -->
      <div class="card">
        <h2><span>ä»Šæ—¥é¥®é£Ÿè§„åˆ’</span><span class="badge">Today</span></h2>
        <p class="sub" id="todayDietSummary">â€”</p>
        <div class="list" id="todayMealList"></div>
        <div class="tagline">æç¤ºï¼šè¯¦ç»†â€œæœ¬æœˆé¥®é£Ÿè®¡åˆ’ + ç”¨é¤æ‰“å¡/è¯†åˆ«â€è¯·åˆ°ã€è¥å…»è®¡åˆ’ã€‘ã€‚</div>
      </div>

      <!-- æ¶ˆæ¯åŠå»ºè®® -->
      <div class="card">
        <h2><span>æ¶ˆæ¯åŠå»ºè®®</span><span class="badge" id="msgBadge">0</span></h2>
        <div class="list" id="msgList"></div>
        <div class="btnrow">
          <button class="btn secondary" onclick="seedDemo()">é‡ç½®ç¤ºä¾‹æ•°æ®</button>
          <button class="btn secondary" onclick="exportData()">å¯¼å‡ºJSON</button>
        </div>
      </div>
    </section>

    <!-- å¥èº«æ–¹æ¡ˆï¼ˆåŸâ€œæœ¬æœˆæ–¹æ¡ˆâ€ï¼Œå†…å®¹ä¿æŒï¼›æ–°å¢æ‹ç…§ä¸Šä¼ æ‰“å¡ï¼‰ -->
    <section id="view-plan" class="grid hidden">
      <div class="card">
        <h2><span>å¥èº«æ–¹æ¡ˆ</span><span class="badge">æœˆåº¦ç›®æ ‡ & æ‰§è¡Œ</span></h2>
        <p class="sub">æœ¬é¡µä¿ç•™åŸâ€œç›®æ ‡ + è¾…åŠ©ç›®æ ‡ + é£é™©é¢„æ¡ˆ + è®­ç»ƒç»“æ„ + é¥®é£Ÿé‡ç‚¹ + æ•™ç»ƒç¡®è®¤â€çš„å®Œæ•´å†…å®¹ï¼Œå¹¶æ–°å¢è®­ç»ƒæ‰“å¡ï¼ˆæ‹ç…§ï¼‰ã€‚</p>

        <div class="item">
          <p class="t">æœˆåº¦ä¸»ç›®æ ‡</p>
          <p class="m" id="planGoalText">â€”</p>
        </div>
        <div class="two">
          <div class="item">
            <p class="t">è¾…åŠ©ç›®æ ‡</p>
            <p class="m" id="planAssistText">â€”</p>
          </div>
          <div class="item">
            <p class="t">é£é™©ç‚¹ä¸é¢„æ¡ˆ</p>
            <p class="m" id="planRiskText">â€”</p>
          </div>
        </div>

        <div class="hr"></div>

        <div class="item">
          <p class="t">è®­ç»ƒç»“æ„ï¼ˆå‘¨ï¼‰</p>
          <p class="m" id="planWorkoutText">â€”</p>
        </div>
        <div class="item">
          <p class="t">é¥®é£ŸåŸåˆ™ï¼ˆæœ¬æœˆé‡ç‚¹ï¼‰</p>
          <p class="m" id="planDietText">â€”</p>
        </div>
        <div class="item">
          <p class="t">æ•™ç»ƒç¡®è®¤</p>
          <p class="m" id="coachConfirmText">â€”</p>
        </div>
      </div>

      <!-- è®­ç»ƒæ‰“å¡ï¼ˆä»…æ˜¾ç¤ºè®°å½•ï¼‰ -->
      <div class="card">
        <h2><span>è®­ç»ƒæ‰“å¡è®°å½•</span><span class="badge">æœ€æ–° 6 æ¡</span></h2>
        <div class="photo-grid" id="workoutPhotoGrid"></div>
      </div>
    </section>

    <!-- è¥å…»è®¡åˆ’ -->
    <section id="view-nutrition" class="grid hidden">
      <div class="card">
        <h2><span>æœ¬æœˆé¥®é£Ÿè®¡åˆ’</span></h2>
        <div id="nutritionEditable" style="font-size:13px;line-height:1.6;color:var(--text);white-space:pre-wrap;padding:10px;background:#f8fafc;border-radius:12px;border:1px solid rgba(226,232,240,.95)"></div>
      </div>

      <!-- æ¯æ—¥é¥®é£Ÿè®¡åˆ’ -->
      <div class="card">
        <h2 style="justify-content:space-between">
          <span>æ¯æ—¥é¥®é£Ÿè®¡åˆ’</span>
          <span style="display:flex;gap:8px;align-items:center">
            <span class="badge">æŒ‰æ—¥æœŸ</span>
            <button class="btn secondary" id="editDailyMealBtn" style="padding:6px 10px;border-radius:10px;font-size:12px" onclick="toggleEditDailyMeal()">ç¼–è¾‘</button>
          </span>
        </h2>
        <p class="sub">æŸ¥çœ‹å’Œç¼–è¾‘æ¯å¤©çš„å›ºå®šä¸‰é¤ï¼ˆæ—©ã€åˆã€æ™šï¼‰å’Œè¡¥ç»™ã€‚</p>

        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px">
          <button class="btn secondary" style="padding:8px 6px;border-radius:10px;white-space:nowrap;font-size:12px" onclick="selectDayMeal('mon')">ä¸€</button>
          <button class="btn secondary" style="padding:8px 6px;border-radius:10px;white-space:nowrap;font-size:12px" onclick="selectDayMeal('tue')">äºŒ</button>
          <button class="btn secondary" style="padding:8px 6px;border-radius:10px;white-space:nowrap;font-size:12px" onclick="selectDayMeal('wed')">ä¸‰</button>
          <button class="btn secondary" style="padding:8px 6px;border-radius:10px;white-space:nowrap;font-size:12px" onclick="selectDayMeal('thu')">å››</button>
          <button class="btn secondary" style="padding:8px 6px;border-radius:10px;white-space:nowrap;font-size:12px" onclick="selectDayMeal('fri')">äº”</button>
          <button class="btn secondary" style="padding:8px 6px;border-radius:10px;white-space:nowrap;font-size:12px" onclick="selectDayMeal('sat')">å…­</button>
          <button class="btn secondary" style="padding:8px 6px;border-radius:10px;white-space:nowrap;font-size:12px" onclick="selectDayMeal('sun')">æ—¥</button>
        </div>

        <div id="mealPlanContent" style="margin-top:10px"></div>
      </div>

      <!-- ç”¨é¤æ‰“å¡ï¼ˆä»…æ˜¾ç¤ºè®°å½•ï¼‰ -->
      <div class="card">
        <h2><span>ç”¨é¤æ‰“å¡è®°å½•</span><span class="badge">æœ€æ–° 6 æ¡</span></h2>
        <div class="photo-grid" id="mealPhotoGrid"></div>
      </div>
    </section>

    <!-- å¤ç›˜å¥–åŠ±ï¼ˆä¿æŒï¼‰ -->
    <section id="view-review" class="grid hidden">
      <div class="card">
        <h2><span>æœˆåº¦ç›®æ ‡è¾¾æˆæ€»ç»“</span><span class="badge">ç•™å­˜æ ¸å¿ƒ</span></h2>
        <p class="sub">æœˆæœ«å¤ç›˜ï¼šå®Œæˆæƒ…å†µã€åŸå› åˆ†æã€ä¸‹æœˆç­–ç•¥ã€‚å¼ºè°ƒå…±åŒå¤ç›˜ï¼Œä¸åšè€ƒæ ¸å¼è¡¨è¾¾ã€‚</p>

        <div class="item">
          <p class="t">è¾¾æˆåº¦</p>
          <p class="m" id="sAchievement">â€”</p>
        </div>
        <div class="item">
          <p class="t">æœ¬æœˆäº®ç‚¹</p>
          <p class="m" id="sWins">â€”</p>
        </div>
        <div class="item">
          <p class="t">éœ€è¦æ”¹è¿›</p>
          <p class="m" id="sGaps">â€”</p>
        </div>
        <div class="btnrow">
          <button class="btn" onclick="openModal('monthlyReview')">å¡«å†™/æ›´æ–°å¤ç›˜</button>
          <button class="btn secondary" onclick="openModal('reward')">æŸ¥çœ‹å¥–åŠ±</button>
        </div>
      </div>

      <div class="card">
        <h2><span>å¥–åŠ±ä¸é‡Œç¨‹ç¢‘</span><span class="badge">è½»æ¿€åŠ±</span></h2>
        <div class="list" id="rewardList"></div>
      </div>
    </section>
  </div>

  <!-- Bottom Tabs (4 tabs) -->
  <nav class="tabs" aria-label="Bottom tabs">
    <div class="tab active" data-tab="home" onclick="go('home')">æ€»è§ˆ</div>
    <div class="tab" data-tab="plan" onclick="go('plan')">å¥èº«æ–¹æ¡ˆ</div>
    <div class="tab" data-tab="nutrition" onclick="go('nutrition')">è¥å…»è®¡åˆ’</div>
    <div class="tab" data-tab="review" onclick="go('review')">å¤ç›˜å¥–åŠ±</div>
  </nav>

  <!-- Floating action buttons -->
  <div class="float-btn coach" id="coachFloat" title="è”ç³»æ•™ç»ƒï¼ˆä¼ä¸šå¾®ä¿¡ï¼‰" onclick="openWeCom()">ğŸ‘¤</div>
  <div class="float-btn workout" id="workoutCheckinFloat" title="æ–°å¢è®­ç»ƒæ‰“å¡" onclick="openModal('workoutCheckin')">ğŸ’ª</div>
  <div class="float-btn meal" id="mealCheckinFloat" title="æ–°å¢ç”¨é¤æ‰“å¡" onclick="openModal('mealCheckin')">ğŸ½ï¸</div>

  <!-- Generic Modal -->
  <div id="modal" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheet-head">
        <div class="sheet-title" id="modalTitle">â€”</div>
        <button class="closebtn" onclick="closeModal()">å…³é—­</button>
      </div>
      <div class="sheet-body" id="modalBody"></div>
      <div class="sheet-actions" id="modalActions"></div>
    </div>
  </div>

  <!-- Coach Drawer (pill opens): contact + feedback in drawer -->
  <div id="coachDrawer" class="overlay hidden" role="dialog" aria-modal="true" onclick="if(event.target.id==='coachDrawer')closeCoachDrawer()">
    <div class="sheet">
      <div class="sheet-head">
        <div class="sheet-title">ä¸“å±æ•™ç»ƒ</div>
        <button class="closebtn" onclick="closeCoachDrawer()">å…³é—­</button>
      </div>
      <div class="sheet-body">
        <!-- Coach Introduction Card with Resume -->
        <div style="display:grid;grid-template-columns:1fr 0.25fr;gap:12px;margin-bottom:16px;padding:12px;background:rgba(37,99,235,.05);border-radius:14px;border:1px solid rgba(37,99,235,.15)">
          <div>
            <div style="margin-bottom:10px">
              <p class="t" id="coachDrawerName" style="margin:0 0 4px">â€”</p>
              <p class="m" id="coachDrawerMeta" style="margin:0 0 8px">â€”</p>
            </div>
            <div style="font-size:12px;color:var(--text);line-height:1.5">
              <p style="margin:0 0 6px;font-weight:650;color:var(--muted)">ä¸“ä¸šè®¤è¯</p>
              <p style="margin:0 0 8px;color:var(--muted)">â€¢ å›½å®¶çº§å¥èº«æ•™ç»ƒèµ„æ ¼è¯ï¼ˆCPTï¼‰<br/>â€¢ è¥å…»å¸ˆèµ„æ ¼è¯ï¼ˆCNDï¼‰<br/>â€¢ è¿åŠ¨åº·å¤ä¸“ä¸šè®¤è¯</p>
              <p style="margin:8px 0 6px;font-weight:650;color:var(--muted)">å·¥ä½œç»å†</p>
              <p style="margin:0 0 8px;color:var(--muted)">â€¢ 12 å¹´å¥èº«è¡Œä¸šç»éªŒ<br/>â€¢ æŒ‡å¯¼å­¦å‘˜ 500+ äºº</p>
              <p style="margin:8px 0 6px;font-weight:650;color:var(--muted)">ä¸“é•¿é¢†åŸŸ</p>
              <p style="margin:0;color:var(--muted)">â€¢ ç§‘å­¦å‡è„‚ã€åº·å¤è®­ç»ƒ</p>
            </div>
          </div>
          <div style="width:60px;height:60px;background:linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0">ğŸ‘©â€ğŸ«</div>
        </div>

        <div class="item">
          <p class="t">ç›‘ç£è§„åˆ™</p>
          <p class="m" id="coachRuleText">â€”</p>
        </div>

        <div class="btnrow">
          <button class="btn" onclick="openWeCom()">è”ç³»æ•™ç»ƒï¼ˆä¼ä¸šå¾®ä¿¡ï¼‰</button>
        </div>

        <div class="hr"></div>

        <div class="item">
          <p class="t">æœåŠ¡åé¦ˆ</p>
          <p class="m">åé¦ˆå°†ç”¨äºä¼˜åŒ–ä¸‹æœˆæœåŠ¡è´¨é‡ä¸æ²Ÿé€šæ–¹å¼ï¼ˆDemoï¼šæœ¬åœ°ä¿å­˜ï¼‰ã€‚</p>

          <div class="field">
            <label>æ•™ç»ƒæ”¯æŒæ˜¯å¦åŠæ—¶ï¼Ÿ</label>
            <select id="fbTimely">
              <option value="å¾ˆåŠæ—¶">å¾ˆåŠæ—¶</option>
              <option value="åŸºæœ¬åŠæ—¶">åŸºæœ¬åŠæ—¶</option>
              <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
              <option value="ä¸åŠæ—¶">ä¸åŠæ—¶</option>
            </select>
          </div>

          <div class="field">
            <label>å»ºè®®æ˜¯å¦å¯æ‰§è¡Œï¼Ÿ</label>
            <select id="fbPractical">
              <option value="éå¸¸å¯æ‰§è¡Œ">éå¸¸å¯æ‰§è¡Œ</option>
              <option value="è¾ƒå¯æ‰§è¡Œ">è¾ƒå¯æ‰§è¡Œ</option>
              <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
              <option value="ä¸å¤ªå¯æ‰§è¡Œ">ä¸å¤ªå¯æ‰§è¡Œ</option>
            </select>
          </div>

          <div class="field">
            <label>å¸Œæœ›ä¸‹æœˆè°ƒæ•´æ²Ÿé€šæ–¹å¼ï¼ˆé€‰å¡«ï¼‰</label>
            <textarea id="fbNote" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›å›ºå®šå‘¨äºŒæ™šå¤ç›˜ï¼›æ›´åå‘è¯­éŸ³æ²Ÿé€šã€‚"></textarea>
          </div>

          <div class="btnrow">
            <button class="btn secondary" onclick="saveFeedback()">æäº¤åé¦ˆ</button>
          </div>

          <div class="hint" style="margin-top:10px" id="fbLast">å°šæœªæäº¤åé¦ˆ</div>
        </div>

        <div class="hint" style="margin-top:12px">
          å…è´£å£°æ˜ï¼šæœ¬æœåŠ¡æä¾›ä¸€èˆ¬æ€§è¿åŠ¨ä¸é¥®é£Ÿè¡Œä¸ºå»ºè®®ï¼Œä¸æ„æˆåŒ»ç–—è¯Šæ–­æˆ–æ²»ç–—ï¼›å¦‚å‡ºç°æ˜æ˜¾ä¸é€‚æˆ–æ—¢å¾€ä¼¤ç—…åŠ é‡ï¼Œè¯·åŠæ—¶å’¨è¯¢åŒ»ç”Ÿæˆ–ä¸“ä¸šæœºæ„ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    const KEY = "fitcare_demo_v2_clean";

    // ======= State =======
    const defaultState = () => ({
      meta: {
        monthLabel: new Date().toLocaleDateString("zh-CN", { year:"numeric", month:"long" }),
        status: "active", // active/warn/paused
        planName: "æ ‡å‡†ç‰ˆ Â· æœˆåº¦è®¢é˜…",
        coachName: "Mia",
        coachServiceTime: "å·¥ä½œæ—¥ 9:00â€“18:00ï¼ˆéå³æ—¶å›å¤ï¼‰",
        // Demo: set your enterprise wecom link/deeplink here
        wecomUrl: "https://work.weixin.qq.com/" // replace with your real link if available
      },
      user: {
        name: "Roger",
        memberId: "FC-2025-1208",
        city: "Shanghai",
        goalPref: "å‡è„‚ + ä½“æ€",
      },
      assessment: {
        bfp: 26.0
      },
      monthly: {
        goalTitle: "12å‘¨è®¡åˆ’ç¬¬1æœˆï¼šä½“è„‚ç‡ä¸‹é™å¹¶å»ºç«‹è§„å¾‹è®­ç»ƒ",
        goalText: "æœ¬æœˆä¸»ç›®æ ‡ï¼šä½“è„‚ç‡ -1%ï¼ˆ26% â†’ 25%ï¼‰ï¼Œè…°å›´ -2cmï¼›å»ºç«‹æ¯å‘¨2-3æ¬¡åŠ›é‡è®­ç»ƒä¹ æƒ¯ã€‚",
        assistText: "è¾…åŠ©ç›®æ ‡ï¼šâ‘  æ¯å‘¨å®Œæˆâ‰¥2æ¬¡è®­ç»ƒï¼›â‘¡ æ¯å¤©è›‹ç™½è´¨ä¼˜å…ˆï¼›â‘¢ æ™šé—´é›¶é£Ÿæ¬¡æ•°â‰¤2æ¬¡/å‘¨ã€‚",
        riskText: "é£é™©ï¼šåŠ ç­/åº”é…¬å¯¼è‡´ä¸­æ–­ã€‚é¢„æ¡ˆï¼šæ”¹ä¸º20åˆ†é’ŸçŸ­è®­ + æ¬¡æ—¥è¡¥è¶³ï¼›åº”é…¬å½“å¤©æ§åˆ¶ä¸»é£Ÿä¸é…’ç²¾ï¼Œæ¬¡æ—¥ä¼˜å…ˆé«˜è›‹ç™½+æ­¥è¡Œã€‚",
        workoutText: "æ¯å‘¨ 3 æ¬¡ï¼šAï¼ˆä¸‹è‚¢+æ ¸å¿ƒï¼‰/Bï¼ˆä¸Šè‚¢+æ ¸å¿ƒï¼‰/Cï¼ˆå…¨èº«å¾ªç¯+è½»æœ‰æ°§ï¼‰ï¼Œå•æ¬¡45-60minã€‚",
        dietText: "æœ¬æœˆé¥®é£Ÿé‡ç‚¹ï¼šâ‘  æ¯é¤å…ˆè›‹ç™½è´¨ï¼›â‘¡ å¤œå®µ/ç”œé¥®æ›¿ä»£æ–¹æ¡ˆï¼›â‘¢ åº”é…¬å½“å¤©â€œå°‘é…’+å°‘ä¸»é£Ÿ+å¤šè”¬èœâ€ã€‚",
        coachConfirmText: "æ•™ç»ƒç¡®è®¤ï¼šæœ¬æœˆä¸ç”¨è¿½æ±‚æé™å‡é‡ï¼Œå…ˆæŠŠè®­ç»ƒé¢‘æ¬¡ç¨³å®šä¸‹æ¥ï¼›é¥®é£ŸæŠ“ä½æ™šé—´å’Œåº”é…¬ä¸¤ä¸ªå…³é”®åœºæ™¯å³å¯ã€‚",
        progress: 35,
        due: "æœ¬æœˆæœˆåº•"
      },
      weekly: {
        plan: 3,
        done: 2,
        dietSelf: "è‰¯å¥½",
        note: "å‘¨ä¸‰åº”é…¬ï¼Œå‘¨äº”åŠ ç­ï¼Œè®­ç»ƒä¸­æ–­ä¸€æ¬¡ã€‚"
      },
      weekCourses: [
        { day:"å‘¨ä¸€", time:"19:30", type:"åŠ›é‡è®­ç»ƒ", status:"å·²å®Œæˆ", link:"https://example.com/booking" },
        { day:"å‘¨ä¸‰", time:"20:00", type:"å›¢è¯¾ HIIT", status:"å·²é¢„çº¦", link:"https://example.com/booking" },
        { day:"å‘¨äº”", time:"19:00", type:"æ‹‰ä¼¸æ¢å¤", status:"å¾…é¢„çº¦", link:"https://example.com/booking" }
      ],
      todayDiet: {
        target: "çƒ­é‡ï¼š1800â€“2100 kcalï¼›è›‹ç™½è´¨ä¼˜å…ˆï¼›æ™šé—´å‡å°‘é«˜ç³–é›¶é£Ÿ",
        meals: [
          { name:"æ—©é¤", plan:"é¸¡è›‹/é…¸å¥¶/ç‡•éº¦ï¼ˆè›‹ç™½è´¨ä¼˜å…ˆï¼‰" },
          { name:"åˆé¤", plan:"ä¸€ä»½ä¼˜è´¨è›‹ç™½ + ä¸¤ä»½è”¬èœ + ä¸€æ‹³ä¸»é£Ÿ" },
          { name:"æ™šé¤", plan:"ä¸»é£Ÿå‡åŠï¼Œä¼˜å…ˆè”¬èœä¸è›‹ç™½è´¨" },
          { name:"åŠ é¤", plan:"å’–å•¡/åšæœå°‘é‡ï¼Œé¿å…å«ç³–é¥®æ–™" }
        ]
      },
      messages: [
        { level:"info", text:"æœ¬æœˆç›®æ ‡ä¸æ–¹æ¡ˆå·²ç”Ÿæˆï¼›è¯·ä¼˜å…ˆæŠŠæ¯å‘¨è®­ç»ƒé¢‘æ¬¡ç¨³å®šä¸‹æ¥ã€‚" },
        { level:"warn", text:"æç¤ºï¼šæœ¬å‘¨è®­ç»ƒå®Œæˆåº¦åä½ï¼Œå¯å¯ç”¨â€œçŸ­è®­é¢„æ¡ˆï¼ˆ20åˆ†é’Ÿï¼‰â€ä¿æŒèŠ‚å¥ã€‚" }
      ],
      coach: {
        rule: "ç›‘ç£è§„åˆ™ï¼šä»¥ç”¨æˆ·æ¯å‘¨åé¦ˆä¸ºä¸»ï¼›è‹¥è¿ç»­2å‘¨è®­ç»ƒæœªå®Œæˆæˆ–é¥®é£ŸæŒç»­åç¦»ï¼Œæ•™ç»ƒå°†ä¸»åŠ¨å»ºè®®è°ƒæ•´æ–¹æ¡ˆã€‚"
      },
      nutrition: {
        coachPlanText:
`ã€æ•™ç»ƒæ¨èã€‘
1ï¼‰çƒ­é‡èŒƒå›´ï¼š1800â€“2100 kcal/å¤©ï¼ˆä¸è¿½æ±‚æé™èŠ‚é£Ÿï¼‰
2ï¼‰è›‹ç™½è´¨ä¼˜å…ˆï¼šæ¯é¤å…ˆåƒè›‹ç™½è´¨ï¼ˆè‚‰/è›‹/å¥¶/è±†åˆ¶å“ï¼‰ï¼Œå†åƒè”¬èœï¼Œæœ€åä¸»é£Ÿ
3ï¼‰æ™šé—´å…³é”®ï¼šå¤œå®µ/ç”œé¥®æ›¿ä»£ï¼ˆç¾å¼/æ°”æ³¡æ°´/æ— ç³–é…¸å¥¶ï¼‰
4ï¼‰åº”é…¬ç­–ç•¥ï¼šå°‘é…’ + å°‘ä¸»é£Ÿ + å¤šè”¬èœï¼›æ¬¡æ—¥ä¼˜å…ˆé«˜è›‹ç™½ + æ­¥è¡Œ
5ï¼‰æ‰§è¡Œå»ºè®®ï¼šæ¯å‘¨è‡³å°‘2æ¬¡è®­ç»ƒæ—¥æŒ‰è®¡åˆ’åƒï¼›éè®­ç»ƒæ—¥ä¹Ÿä¿æŒè›‹ç™½è´¨ä¼˜å…ˆ`,
        userEditedText: null,
        lastSavedAt: null,
        lastReviewRequestAt: null,
        dailyPlans: {
          mon: { breakfast: "é¸¡è›‹3ä¸ª + ç‡•éº¦ç‰‡50g + ç‰›å¥¶200ml", lunch: "é¸¡èƒ¸è‚‰150g + ç³™ç±³200g + è¥¿å…°èŠ±100g + æ©„æ¦„æ²¹5ml", dinner: "ä¸‰æ–‡é±¼150g + ç™½ç²¥200g + é’èœ150g", snack: "æä»25g + é»‘å’–å•¡" },
          tue: { breakfast: "å¸Œè…Šé…¸å¥¶150g + è“è“50g + åšæœ20g", lunch: "ç‰›è‚‰100g + çº¢è–¯200g + èƒ¡èåœ100g + èŠéº»æ²¹5ml", dinner: "è±†è…150g + ç±³é¥­150g + è èœ100g", snack: "é¦™è•‰1æ ¹" },
          wed: { breakfast: "å…¨éº¦é¢åŒ…2ç‰‡ + ç•ªèŒ„é…± + é¸¡è›‹2ä¸ª + ç‰›å¥¶", lunch: "çŒªé‡Œè„Š150g + ç³™ç±³200g + ç•ªèŒ„100g + æ´‹è‘±50g", dinner: "é±¼ç±»150g + æ¸…ç²¥150g + å†¬ç“œ100g + ç›/è°ƒæ–™", snack: "åšæœæ··åˆ25g" },
          thu: { breakfast: "ç‡•éº¦ç²¥ï¼ˆç‡•éº¦50g + ç‰›å¥¶200ml + èœ‚èœœ10gï¼‰+ è‰è“", lunch: "è™¾ä»150g + ç³™ç±³200g + è±Œè±†100g + æ´‹è‘±50g", dinner: "é¸¡è…¿150g + çº¢è–¯200g + ç”Ÿèœ100g", snack: "é…¸å¥¶100g" },
          fri: { breakfast: "è›‹ç™½ç²‰25g + é¦™è•‰ + ç‰›å¥¶200ml + ç‡•éº¦30g", lunch: "ç‰›è‚‰150g + ç™½ç±³200g + èƒ¡èåœ100g + ç‰ç±³50g", dinner: "é±¼ç±»150g + æ¸…æ±¤ + è±†è…100g + é’èœ100g", snack: "æ ¸æ¡ƒ15g" },
          sat: { breakfast: "å…¨éº¦é¢åŒ…3ç‰‡ + èŠ±ç”Ÿé…±15g + é¸¡è›‹1ä¸ª + æ©™æ±", lunch: "é¸¡èƒ¸è‚‰150g + ç³™ç±³200g + å—ç“œ100g + æ´‹è‘±50g", dinner: "è™¾150g + æ¸…ç²¥150g + å†¬ç“œ100g + é¦™è‡50g", snack: "ä½è„‚ç‰›å¥¶200ml" },
          sun: { breakfast: "é…¸å¥¶150g + æ ¼å…°è¯ºæ‹‰éº¦ç‰‡40g + èœ‚èœœ10g + æµ†æœ", lunch: "çŒªè‚‰150g + çº¢è–¯200g + è¥¿å…°èŠ±100g + èŠéº»æ²¹", dinner: "é±¼ç±»150g + ç±³é¥­150g + é’èœ100g + ç•ªèŒ„æ±¤", snack: "åšæœæ£’1æ ¹" }
        },
        currentDay: "mon"
      },
      checkins: {
        workouts: [
          // { at, title, note, photoDataUrl? }
        ],
        meals: [
          // { at, mealType, desc, kcal, photoDataUrl? }
        ]
      },
      summary: {
        achievement: "è¿›è¡Œä¸­ï¼ˆå»ºè®®æœˆæœ«å¡«å†™ï¼‰",
        wins: "â€”",
        gaps: "â€”"
      },
      rewards: [
        { t:"è¾¾æˆæœ¬æœˆä¸»ç›®æ ‡", m:"å¥–åŠ±ï¼šä¸‹æœˆå¢åŠ ä¸€æ¬¡æ·±åº¦è°ƒæ•´ï¼ˆ30minï¼‰", ok:false },
        { t:"è¿ç»­2å‘¨å®Œæˆâ‰¥2æ¬¡è®­ç»ƒ", m:"å¥–åŠ±ï¼šä¼˜å…ˆæ’è¯¾/ä¼˜å…ˆå’¨è¯¢", ok:true },
        { t:"è¿ç»­3ä¸ªæœˆè®¢é˜…", m:"å¥–åŠ±ï¼šä½“æµ‹å‡çº§æˆ–æ²Ÿé€šé¢‘æ¬¡å‡çº§", ok:false }
      ],
      feedback: {
        lastAt: null,
        timely: null,
        practical: null,
        note: null
      }
    });

    function load(){
      const raw = localStorage.getItem(KEY);
      if(!raw) { const s = defaultState(); save(s); return s; }
      try { return JSON.parse(raw); } catch(e){
        const s = defaultState(); save(s); return s;
      }
    }
    function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
    let state = load();

    // ======= Navigation =======
    function go(tab){
      const views = {
        home:"view-home",
        plan:"view-plan",
        nutrition:"view-nutrition",
        review:"view-review"
      };
      Object.values(views).forEach(id => document.getElementById(id).classList.add("hidden"));
      document.getElementById(views[tab] || views.home).classList.remove("hidden");

      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      const el = document.querySelector(`.tab[data-tab="${tab}"]`);
      if(el) el.classList.add("active");

      // Show all floating buttons on every tab
      document.getElementById("workoutCheckinFloat").style.display = "flex";
      document.getElementById("mealCheckinFloat").style.display = "flex";

      window.scrollTo({top:0, behavior:"smooth"});
      renderFloatingCoachOffset();
    }

    // ======= Rendering =======
    function renderAll(){
      // Top pills
      document.getElementById("monthLabel").textContent = state.meta.monthLabel;
      document.getElementById("coachName").textContent = state.meta.coachName;
      document.getElementById("planNameBadge").textContent = state.meta.planName;

      // status
      const dot = document.getElementById("statusDot");
      const statusText = document.getElementById("serviceStatus");
      dot.classList.remove("warn","bad");
      if(state.meta.status==="active"){
        statusText.textContent = "æœåŠ¡ä¸­";
      }else if(state.meta.status==="warn"){
        dot.classList.add("warn");
        statusText.textContent = "éœ€å…³æ³¨";
      }else{
        dot.classList.add("bad");
        statusText.textContent = "æš‚åœ";
      }

      // user overview (keep rich)
      document.getElementById("userLine").textContent =
        `${state.user.name} Â· ${state.user.city} Â· ä¼šå‘˜ID ${state.user.memberId} Â· ç›®æ ‡åå¥½ï¼š${state.user.goalPref}`;

      document.getElementById("kpiBfp").textContent = `${Number(state.assessment.bfp||0).toFixed(1)}%`;
      document.getElementById("kpiWorkout").textContent = `${state.weekly.done}/${state.weekly.plan}`;
      document.getElementById("kpiDiet").textContent = state.weekly.dietSelf;

      // goal
      document.getElementById("goalTitle").textContent = state.monthly.goalTitle;
      document.getElementById("goalBar").style.width = `${clamp(state.monthly.progress,0,100)}%`;
      document.getElementById("goalProgressText").textContent = `å½“å‰è¿›åº¦ï¼š${state.monthly.progress}%`;
      document.getElementById("goalDueText").textContent = `æˆªæ­¢ï¼š${state.monthly.due}`;
      document.getElementById("goalStatus").textContent =
        state.monthly.progress>=100 ? "å·²å®Œæˆ" : (state.monthly.progress>=60 ? "æ¨è¿›è‰¯å¥½" : "è¿›è¡Œä¸­");

      // week courses
      const weekClassList = document.getElementById("weekClassList");
      weekClassList.innerHTML = "";
      state.weekCourses.forEach(c=>{
        const badge = c.status==="å·²å®Œæˆ" ? "âœ…" : (c.status==="å·²é¢„çº¦" ? "ğŸ—“ï¸" : "â³");
        const actionText = c.status==="å¾…é¢„çº¦" ? "å»é¢„çº¦" : "æŸ¥çœ‹";
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="row" style="align-items:flex-start">
            <div>
              <p class="t">${badge} ${escapeHtml(c.day)} ${escapeHtml(c.time)} Â· ${escapeHtml(c.type)}</p>
              <p class="m">çŠ¶æ€ï¼š<b>${escapeHtml(c.status)}</b></p>
            </div>
            <a class="btn secondary" style="padding:8px 10px;border-radius:12px" href="${escapeAttr(c.link)}" target="_blank" rel="noopener">${actionText}</a>
          </div>
        `;
        weekClassList.appendChild(div);
      });

      // today diet
      document.getElementById("todayDietSummary").textContent = state.todayDiet.target;
      const mealList = document.getElementById("todayMealList");
      mealList.innerHTML = "";
      state.todayDiet.meals.forEach(m=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<p class="t">${escapeHtml(m.name)}</p><p class="m">${escapeHtml(m.plan)}</p>`;
        mealList.appendChild(div);
      });

      // messages
      const msgList = document.getElementById("msgList");
      msgList.innerHTML = "";
      document.getElementById("msgBadge").textContent = String(state.messages.length);
      state.messages.slice().reverse().forEach(m=>{
        const div = document.createElement("div");
        div.className = "item";
        const badge = m.level==="warn" ? "âš ï¸" : (m.level==="bad" ? "â›”" : "â„¹ï¸");
        div.innerHTML = `<p class="t">${badge} ${escapeHtml(m.text)}</p><p class="m">ï¼ˆåªè¯»å»ºè®® / Demoï¼‰</p>`;
        msgList.appendChild(div);
      });

      // plan content
      document.getElementById("planGoalText").textContent = state.monthly.goalText;
      document.getElementById("planAssistText").textContent = state.monthly.assistText;
      document.getElementById("planRiskText").textContent = state.monthly.riskText;
      document.getElementById("planWorkoutText").textContent = state.monthly.workoutText;
      document.getElementById("planDietText").textContent = state.monthly.dietText;
      document.getElementById("coachConfirmText").textContent = state.monthly.coachConfirmText;

      // workout photo grid (latest 6)
      renderPhotoGrid("workoutPhotoGrid", state.checkins.workouts, "è®­ç»ƒ");

      // nutrition editable
      const text = state.nutrition.userEditedText ?? state.nutrition.coachPlanText;
      const ed = document.getElementById("nutritionEditable");
      if(ed.textContent.trim() !== text.trim()){
        ed.textContent = text;
      }

      // daily meal plan - render first day
      renderDailyMealPlan(state.nutrition.currentDay);

      // meal photo grid (latest 6)
      renderPhotoGrid("mealPhotoGrid", state.checkins.meals, "ç”¨é¤");

      // review
      document.getElementById("sAchievement").textContent = state.summary.achievement;
      document.getElementById("sWins").textContent = state.summary.wins;
      document.getElementById("sGaps").textContent = state.summary.gaps;

      const rewardList = document.getElementById("rewardList");
      rewardList.innerHTML = "";
      state.rewards.forEach(r=>{
        const div = document.createElement("div");
        div.className = "item";
        const status = r.ok ? "âœ…" : "â³";
        div.innerHTML = `<p class="t">${status} ${escapeHtml(r.t)}</p><p class="m">${escapeHtml(r.m)}</p>`;
        rewardList.appendChild(div);
      });

      // coach drawer prefill
      renderCoachDrawer();

      renderFloatingCoachOffset();
    }

    function renderPhotoGrid(containerId, items, tag){
      const grid = document.getElementById(containerId);
      grid.innerHTML = "";
      const latest = items.slice().sort((a,b)=>b.at-a.at).slice(0,6);
      if(latest.length===0){
        const div = document.createElement("div");
        div.className = "hint";
        div.textContent = `æš‚æ— ${tag}æ‰“å¡ã€‚`;
        grid.appendChild(div);
        return;
      }
      latest.forEach(it=>{
        const cell = document.createElement("div");
        cell.className = "photo";
        if(it.photoDataUrl){
          cell.innerHTML = `<img alt="" src="${escapeAttr(it.photoDataUrl)}" /><small>${escapeHtml(tag)}</small>`;
        }else{
          cell.innerHTML = `<div class="hint" style="margin:10px;text-align:center">æ— ç…§ç‰‡<br><span style="font-size:11px">${escapeHtml(tag)}è®°å½•</span></div>`;
        }
        grid.appendChild(cell);
      });
    }

    function renderCoachDrawer(){
      document.getElementById("coachDrawerName").textContent = `æ•™ç»ƒ ${state.meta.coachName}`;
      document.getElementById("coachDrawerMeta").textContent = state.meta.coachServiceTime;
      document.getElementById("coachRuleText").textContent = state.coach.rule;

      // feedback
      const fb = state.feedback;
      if(fb.timely) document.getElementById("fbTimely").value = fb.timely;
      if(fb.practical) document.getElementById("fbPractical").value = fb.practical;
      document.getElementById("fbNote").value = fb.note || "";

      const fbLast = document.getElementById("fbLast");
      if(!fb.lastAt){
        fbLast.textContent = "å°šæœªæäº¤åé¦ˆ";
      }else{
        fbLast.textContent = `ä¸Šæ¬¡æäº¤ï¼š${fmtTime(fb.lastAt)} Â· åŠæ—¶æ€§ï¼š${fb.timely} Â· å¯æ‰§è¡Œæ€§ï¼š${fb.practical}${fb.note ? " Â· å¤‡æ³¨å·²å¡«å†™" : ""}`;
      }
    }

    function renderFloatingCoachOffset(){
      // All floating buttons are now positioned via CSS
    }

    // ======= Coach / WeCom =======
    function openWeCom(){
      const url = state.meta.wecomUrl || "https://work.weixin.qq.com/";
      window.open(url, "_blank", "noopener");
    }
    document.getElementById("coachPill").addEventListener("click", openCoachDrawer);

    function openCoachDrawer(){
      document.getElementById("coachDrawer").classList.remove("hidden");
      renderCoachDrawer();
    }
    function closeCoachDrawer(){
      const el = document.getElementById("coachDrawer");
      el.classList.add("hidden");
    }

    // ======= Nutrition (Monthly plan - read only) =======
    // æœ¬æœˆé¥®é£Ÿè®¡åˆ’ä¸ºæ•™ç»ƒæ¨èçš„å›ºå®šå†…å®¹ï¼Œåªè¯»ï¼Œä¸éœ€è¦ç¼–è¾‘å‡½æ•°

    function requestCoachReview(){
      // record request time & add a system message (read-only)
      state.nutrition.lastReviewRequestAt = Date.now();
      state.messages.push({
        level: "info",
        text: "ä½ å·²è¯·æ±‚æ•™ç»ƒå¤æ ¸è¥å…»è®¡åˆ’ä¿®æ”¹ï¼šè¯·åœ¨ä¼ä¸šå¾®ä¿¡ä¸­è¯´æ˜æœ¬æ¬¡ä¿®æ”¹ç‚¹ï¼ˆDemo è®°å½•ï¼‰ã€‚"
      });
      save(state);
      renderAll();
      toast("å·²è®°å½•å¤æ ¸è¯·æ±‚ï¼Œæ­£åœ¨è·³è½¬ä¼ä¸šå¾®ä¿¡");
      openWeCom();
    }

    // ======= Daily Meal Plan =======
    let isEditingDailyMeal = false;

    function toggleEditDailyMeal(){
      isEditingDailyMeal = !isEditingDailyMeal;
      const btn = document.getElementById("editDailyMealBtn");
      const cont = document.getElementById("mealPlanContent");
      
      if(isEditingDailyMeal){
        btn.textContent = "å®Œæˆ";
        btn.classList.remove('secondary');
        // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼ - ä½¿æ‰€æœ‰è¾“å…¥æ¡†å¯ç¼–è¾‘
        const inputs = cont.querySelectorAll('input');
        inputs.forEach(inp => inp.readOnly = false);
        inputs[0]?.focus();
      }else{
        // å®Œæˆç¼–è¾‘ - å¼¹å‡ºéœ€è¦äº‹é¡¹å¯¹è¯
        btn.textContent = "ç¼–è¾‘";
        btn.classList.add('secondary');
        const inputs = cont.querySelectorAll('input');
        inputs.forEach(inp => inp.readOnly = true);
        // ä¿å­˜ä¸¦å¼¹å‡ºæ•™ç»ƒå¤æ ¸å¯¹è¯
        saveDailyMealQuiet();
        openCoachReviewPrompt();
      }
    }

    function renderDailyMealPlan(day){
      state.nutrition.currentDay = day;
      const plan = state.nutrition.dailyPlans[day] || {};
      const cont = document.getElementById("mealPlanContent");
      if(!cont) return;
      
      cont.innerHTML = `
        <div class="item">
          <p class="t">æ—©é¤</p>
          <input type="text" id="meal-breakfast" value="${escapeAttr(plan.breakfast||'')}" style="width:100%;margin-top:4px" placeholder="è¾“å…¥æ—©é¤å†…å®¹" readonly />
        </div>
        <div class="item">
          <p class="t">åˆé¤</p>
          <input type="text" id="meal-lunch" value="${escapeAttr(plan.lunch||'')}" style="width:100%;margin-top:4px" placeholder="è¾“å…¥åˆé¤å†…å®¹" readonly />
        </div>
        <div class="item">
          <p class="t">æ™šé¤</p>
          <input type="text" id="meal-dinner" value="${escapeAttr(plan.dinner||'')}" style="width:100%;margin-top:4px" placeholder="è¾“å…¥æ™šé¤å†…å®¹" readonly />
        </div>
        <div class="item">
          <p class="t">è¡¥ç»™</p>
          <input type="text" id="meal-snack" value="${escapeAttr(plan.snack||'')}" style="width:100%;margin-top:4px" placeholder="è¾“å…¥è¡¥ç»™å†…å®¹" readonly />
        </div>
      `;
    }

    function selectDayMeal(day){
      renderDailyMealPlan(day);
      // é«˜äº®é€‰ä¸­çš„æ—¥æœŸæŒ‰é’®
      const btns = document.querySelectorAll('.card:nth-child(2) .btnrow .btn');
      const days = ['mon','tue','wed','thu','fri','sat','sun'];
      btns.forEach((btn,i)=>{
        if(days[i]===day){
          btn.classList.remove('secondary');
        }else{
          btn.classList.add('secondary');
        }
      });
    }

    function saveDailyMealQuiet(){
      // ä¸å¼¹æç¤ºï¼Œä¼šå–è€Œå¼¹å‡ºæ•™ç»ƒå¤æ ¸å¯¹è¯
      const day = state.nutrition.currentDay;
      state.nutrition.dailyPlans[day] = {
        breakfast: document.getElementById('meal-breakfast').value.trim(),
        lunch: document.getElementById('meal-lunch').value.trim(),
        dinner: document.getElementById('meal-dinner').value.trim(),
        snack: document.getElementById('meal-snack').value.trim()
      };
      save(state);
    }

    function openCoachReviewPrompt(){
      openModalRaw("æ˜¯å¦éœ€è¦æ•™ç»ƒå¤æ ¸ï¼Ÿ", `
        <p>æ‚¨å·²ä¸æ–¹ä¾¿æ•´ç†äº†æ¯æ—¥é¥®é£Ÿè®¡åˆ’ã€‚æ˜¯å¦éœ€è¦è¯·æ•™ç»ƒå¤æ ¸æ‚¨çš„ä¿®æ”¹å¹¶ç»™å‡ºå»ºè®®ï¼Ÿ</p>
        <div class="hint" style="margin-top:12px">å¦‚æœæ‚¨æœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆå¦¨è¿·ã€ä¸è€å—æˆåˆ†ã€çˆ±å¥½å¤‰åŒ–ç­‰ï¼‰ï¼Œè¯·åœ¨ä¼ä¸šå¾®ä¿¡ä¸­å‘Šè¯‰æ•™ç»ƒã€‚</div>
      `, [
        { label:"æ˜¯ï¼Œæ¥å¤æ ¸", cls:"", onClick: ()=>{ state.nutrition.lastReviewRequestAt = Date.now(); state.messages.push({ level:"info", text:"æ‚¨å·²è¯·æ•™ç»ƒå¤æ ¸æ¯æ—¥é¤é§Ÿä¿®æ”¹ï¼Œè¯·åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æŸ¥çœ‹ï¼ˆDemoè®°å½•ï¼‰ã€‚" }); save(state); renderAll(); closeModal(); toast("å·²è®°å½•å¤æ ¸è¯·æ±‚"); openWeCom(); }},
        { label:"ä¸éœ€è¦ï¼Œè¿½ä¸‹", cls:"secondary", onClick: closeModal }
      ]);
    }

    // ======= Modal =======
    function openModal(kind){
      if(kind==="updateGoal"){
        openModalRaw("æ›´æ–°æœˆåº¦è¿›åº¦", `
          <div class="field">
            <label>å½“å‰è¿›åº¦ï¼ˆ0-100ï¼‰</label>
            <input id="mProgress" type="number" min="0" max="100" value="${escapeAttr(state.monthly.progress)}" />
          </div>
          <div class="field">
            <label>ç›®æ ‡çŠ¶æ€ï¼ˆå¯é€‰ï¼‰</label>
            <select id="mStatus">
              <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
              <option value="æ¨è¿›è‰¯å¥½">æ¨è¿›è‰¯å¥½</option>
              <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
            </select>
          </div>
          <div class="hint">æç¤ºï¼šæ­£å¼ç‰ˆå¯æŒ‰â€œè®­ç»ƒå®Œæˆåº¦ + é¥®é£Ÿæ‰§è¡Œ + å¤è¯„æ•°æ®â€ç»¼åˆè®¡ç®—è¿›åº¦ã€‚</div>
        `, [
          { label:"ä¿å­˜", cls:"", onClick: ()=>{
            const p = Number(document.getElementById("mProgress").value || 0);
            state.monthly.progress = clamp(p,0,100);
            const s = document.getElementById("mStatus").value;
            if(s==="å·²å®Œæˆ") state.monthly.progress = 100;

            if(state.monthly.progress>=100){
              state.summary.achievement = "å·²å®Œæˆï¼ˆè¯·å¡«å†™æœ¬æœˆäº®ç‚¹ä¸æ”¹è¿›ç‚¹ï¼‰";
              state.messages.push({ level:"info", text:"æ­å–œï¼ä½ å·²æ ‡è®°æœ¬æœˆç›®æ ‡å®Œæˆï¼Œå»ºè®®åˆ°â€œå¤ç›˜å¥–åŠ±â€å¡«å†™æ€»ç»“ã€‚" });
              state.rewards = state.rewards.map(r => r.t==="è¾¾æˆæœ¬æœˆä¸»ç›®æ ‡" ? ({...r, ok:true}) : r);
            }
            state.meta.status = (state.monthly.progress<40 && state.weekly.plan>0 && (state.weekly.done/state.weekly.plan)<0.5) ? "warn" : "active";

            save(state); renderAll(); closeModal(); toast("å·²æ›´æ–°");
          }},
          { label:"å–æ¶ˆ", cls:"secondary", onClick: closeModal }
        ]);
        setTimeout(()=>{
          document.getElementById("mStatus").value =
            (state.monthly.progress>=100?"å·²å®Œæˆ":(state.monthly.progress>=60?"æ¨è¿›è‰¯å¥½":"è¿›è¡Œä¸­"));
        },0);
      }

      if(kind==="weeklyRecord"){
        openModalRaw("æ›´æ–°æœ¬å‘¨æ‰§è¡Œè®°å½•", `
          <div class="two">
            <div class="field">
              <label>æœ¬å‘¨è®¡åˆ’è®­ç»ƒæ¬¡æ•°</label>
              <input id="wkPlan" type="number" min="0" value="${escapeAttr(state.weekly.plan)}" />
            </div>
            <div class="field">
              <label>æœ¬å‘¨å·²å®Œæˆæ¬¡æ•°</label>
              <input id="wkDone" type="number" min="0" value="${escapeAttr(state.weekly.done)}" />
            </div>
          </div>

          <div class="field">
            <label>æœ¬å‘¨é¥®é£Ÿæ‰§è¡Œè‡ªè¯„</label>
            <select id="dietSelf">
              ${["ä¼˜ç§€","è‰¯å¥½","ä¸€èˆ¬","è¾ƒå·®"].map(v=>`<option value="${v}">${v}</option>`).join("")}
            </select>
          </div>

          <div class="field">
            <label>æœ¬å‘¨ç®€è¦å¤‡æ³¨ï¼ˆå¯å†™ï¼šåº”é…¬/åŠ ç­/ä¸é€‚ï¼‰</label>
            <textarea id="wkNote" placeholder="ä¾‹å¦‚ï¼šå‘¨ä¸‰åº”é…¬ï¼Œå‘¨äº”åŠ ç­åˆ°å‡Œæ™¨ï¼Œè®­ç»ƒä¸­æ–­ä¸€æ¬¡ã€‚">${escapeHtml(state.weekly.note || "")}</textarea>
          </div>
        `, [
          { label:"ä¿å­˜", cls:"", onClick: ()=>{
            const plan = Number(document.getElementById("wkPlan").value || 0);
            const done = Number(document.getElementById("wkDone").value || 0);
            const dietSelf = document.getElementById("dietSelf").value;
            const note = document.getElementById("wkNote").value.trim();

            state.weekly = { plan, done, dietSelf, note };

            const ratio = plan>0 ? (done/plan) : 0;
            if(plan>0 && ratio < 0.5){
              state.meta.status = "warn";
              state.messages.push({ level:"warn", text:"æœ¬å‘¨è®­ç»ƒå®Œæˆåº¦åä½ï¼šå»ºè®®å¯ç”¨çŸ­è®­é¢„æ¡ˆï¼ˆ20åˆ†é’Ÿï¼‰ä¿æŒèŠ‚å¥ã€‚" });
            }else{
              state.meta.status = "active";
            }
            save(state); renderAll(); closeModal(); toast("å·²ä¿å­˜");
          }},
          { label:"å–æ¶ˆ", cls:"secondary", onClick: closeModal }
        ]);
        setTimeout(()=>{ document.getElementById("dietSelf").value = state.weekly.dietSelf; },0);
      }

      if(kind==="workoutCheckin"){
        openModalRaw("æ–°å¢è®­ç»ƒæ‰“å¡", `
          <div class="field">
            <label>è®­ç»ƒæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
            <input id="wTitle" placeholder="ä¾‹å¦‚ï¼šåŠ›é‡è®­ç»ƒ A / æ‹‰ä¼¸æ¢å¤" />
          </div>
          <div class="field">
            <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
            <textarea id="wNote" placeholder="ä¾‹å¦‚ï¼šä¸‹è‚¢é…¸èƒ€ï¼Œæ•´ä½“çŠ¶æ€OKã€‚"></textarea>
          </div>
          <div class="field">
            <label>ä¸Šä¼ ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
            <input id="wPhoto" type="file" accept="image/*" />
            <div class="tagline">ç…§ç‰‡å°†å‹ç¼©åä¿å­˜åœ¨æœ¬åœ°ï¼ˆDemoï¼‰ã€‚</div>
          </div>
        `, [
          { label:"ä¿å­˜", cls:"", onClick: async ()=>{
            const title = document.getElementById("wTitle").value.trim() || "è®­ç»ƒæ‰“å¡";
            const note = document.getElementById("wNote").value.trim();
            const file = document.getElementById("wPhoto").files?.[0] || null;

            let photoDataUrl = null;
            if(file){
              try { photoDataUrl = await compressImageToDataUrl(file, 900, 0.82); }
              catch(e){ /* ignore */ }
            }
            state.checkins.workouts.push({ at: Date.now(), title, note, photoDataUrl });
            state.messages.push({ level:"info", text:"å·²æ–°å¢è®­ç»ƒæ‰“å¡è®°å½•ï¼ˆå¦‚éœ€è°ƒæ•´æ–¹æ¡ˆï¼Œè¯·ç›´æ¥è”ç³»æ•™ç»ƒï¼‰ã€‚" });
            save(state); renderAll(); closeModal(); toast("å·²ä¿å­˜è®­ç»ƒæ‰“å¡");
          }},
          { label:"å–æ¶ˆ", cls:"secondary", onClick: closeModal }
        ]);
      }

      if(kind==="mealCheckin"){
        openModalRaw("æ–°å¢ç”¨é¤æ‰“å¡", `
          <div class="field">
            <label>æ‹ç…§/ä¸Šä¼ ç…§ç‰‡</label>
            <div style="border: 2px dashed rgba(37,99,235,.35); border-radius: 14px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s ease;" id="photoUploadBox" onclick="document.getElementById('mPhoto').click()">
              <div style="font-size: 48px; margin-bottom: 10px">ğŸ“¸</div>
              <p style="font-size: 14px; color: var(--accent); font-weight: 650; margin: 0">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</p>
              <p style="font-size: 12px; color: var(--muted); margin: 6px 0 0 0">æ”¯æŒ JPGã€PNG æ ¼å¼</p>
              <input id="mPhoto" type="file" accept="image/*" style="display: none;" onchange="handlePhotoUpload()" />
            </div>
            <div id="photoPreview" style="margin-top: 10px"></div>
          </div>

          <div class="two">
            <div class="field">
              <label>è®°å½•æ—¶é—´</label>
              <input id="mTime" type="text" value="${new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})}" readonly />
            </div>
            <div class="field">
              <label>ç”¨é¤ç±»å‹</label>
              <select id="mType">
                <option value="æ—©é¤">æ—©é¤</option>
                <option value="åˆé¤">åˆé¤</option>
                <option value="æ™šé¤">æ™šé¤</option>
                <option value="åŠ é¤">åŠ é¤</option>
              </select>
            </div>
          </div>

          <div class="hint" style="background: rgba(37,99,235,.08); border: 1px solid rgba(37,99,235,.18)">
            âœ¨ ä¸Šä¼ ç…§ç‰‡åç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆæè¿°å’Œå¡è·¯é‡Œä¼°ç®—å€¼ã€‚
          </div>
        `, [
          { label:"ä¿å­˜", cls:"", onClick: async ()=>{
            const mealType = document.getElementById("mType").value;
            const file = document.getElementById("mPhoto").files?.[0] || null;

            if(!file){
              toast("è¯·é€‰æ‹©ç…§ç‰‡");
              return;
            }

            let photoDataUrl = null;
            try { photoDataUrl = await compressImageToDataUrl(file, 900, 0.82); }
            catch(e){ /* ignore */ }

            // Auto-generate description and calorie estimate
            const desc = "ç…§ç‰‡å·²ä¸Šä¼ " + (mealType || "");
            let kcal = 500; // default estimate
            if(mealType==="æ—©é¤") kcal = 420;
            else if(mealType==="åˆé¤") kcal = 680;
            else if(mealType==="æ™šé¤") kcal = 720;
            else kcal = 300;

            state.checkins.meals.push({ at: Date.now(), mealType, desc, kcal, photoDataUrl });
            save(state); renderAll(); closeModal(); toast("å·²ä¿å­˜ç”¨é¤æ‰“å¡ï¼Œè‡ªåŠ¨ä¼°ç®— " + kcal + " kcal");
          }},
          { label:"å–æ¶ˆ", cls:"secondary", onClick: closeModal }
        ]);
      }

      if(kind==="allWorkoutPhotos"){
        const items = state.checkins.workouts.slice().sort((a,b)=>b.at-a.at);
        openModalRaw("è®­ç»ƒæ‰“å¡è®°å½•ï¼ˆå…¨éƒ¨ï¼‰", buildCheckinListHtml(items, "workout"), [
          { label:"å…³é—­", cls:"secondary", onClick: closeModal }
        ]);
      }

      if(kind==="allMealPhotos"){
        const items = state.checkins.meals.slice().sort((a,b)=>b.at-a.at);
        openModalRaw("ç”¨é¤æ‰“å¡è®°å½•ï¼ˆå…¨éƒ¨ï¼‰", buildCheckinListHtml(items, "meal"), [
          { label:"å…³é—­", cls:"secondary", onClick: closeModal }
        ]);
      }

      if(kind==="monthlyReview"){
        openModalRaw("å¡«å†™æœˆåº¦å¤ç›˜", `
          <div class="field"><label>è¾¾æˆåº¦æè¿°</label><input id="sa" value="${escapeAttr(state.summary.achievement)}" /></div>
          <div class="field"><label>æœ¬æœˆäº®ç‚¹ï¼ˆåšåˆ°äº†ä»€ä¹ˆï¼‰</label><textarea id="sw">${escapeHtml(state.summary.wins)}</textarea></div>
          <div class="field"><label>éœ€è¦æ”¹è¿›ï¼ˆä¸ºä»€ä¹ˆæ²¡åšåˆ°/ä¸‹æœˆæ€ä¹ˆåšï¼‰</label><textarea id="sg">${escapeHtml(state.summary.gaps)}</textarea></div>
        `, [
          { label:"ä¿å­˜", cls:"", onClick: ()=>{
            state.summary.achievement = document.getElementById("sa").value.trim();
            state.summary.wins = document.getElementById("sw").value.trim();
            state.summary.gaps = document.getElementById("sg").value.trim();
            state.messages.push({ level:"info", text:"å·²æ›´æ–°æœ¬æœˆå¤ç›˜å†…å®¹ï¼ˆDemoï¼‰ã€‚" });
            save(state); renderAll(); closeModal(); toast("å·²ä¿å­˜");
          }},
          { label:"å–æ¶ˆ", cls:"secondary", onClick: closeModal }
        ]);
      }

      if(kind==="reward"){
        const html = `
          <div class="hint">å¥–åŠ±å»ºè®®ï¼šä»¥â€œæœåŠ¡æƒç›Šâ€ä¸ºä¸»ï¼ˆä¼˜å…ˆæ’è¯¾/é¢å¤–å¤ç›˜/å‡çº§ä½“æµ‹ï¼‰ï¼Œé¿å…æˆæœ¬å¤±æ§ã€‚</div>
          <div class="list" style="margin-top:10px">
            ${state.rewards.map((r,i)=>`
              <div class="item">
                <p class="t">${r.ok?"âœ…":"â³"} ${escapeHtml(r.t)}</p>
                <p class="m">${escapeHtml(r.m)}</p>
                <div class="btnrow" style="margin-top:8px">
                  <button class="btn secondary" onclick="toggleReward(${i})">${r.ok?"æ ‡è®°æœªè¾¾æˆ":"æ ‡è®°å·²è¾¾æˆ"}</button>
                </div>
              </div>
            `).join("")}
          </div>
        `;
        openModalRaw("å¥–åŠ±ä¸é‡Œç¨‹ç¢‘", html, [
          { label:"å…³é—­", cls:"secondary", onClick: closeModal }
        ]);
      }
    }

    function buildCheckinListHtml(items, kind){
      if(items.length===0) return `<div class="hint">æš‚æ— è®°å½•ã€‚</div>`;
      return `
        <div class="list">
          ${items.map((it, idx)=>{
            const when = fmtTime(it.at);
            const title = kind==="workout"
              ? escapeHtml(it.title || "è®­ç»ƒæ‰“å¡")
              : `${escapeHtml(it.mealType || "ç”¨é¤")} Â· ${escapeHtml(it.desc||"") || "ï¼ˆæ— æè¿°ï¼‰"}`;
            const sub = kind==="workout"
              ? escapeHtml(it.note || "â€”")
              : `çƒ­é‡ï¼š<b>${Number(it.kcal||0)}</b> kcalï¼ˆä¼°ç®—/å¯æ‰‹æ”¹ï¼‰`;
            const img = it.photoDataUrl ? `<div style="margin-top:8px"><img src="${escapeAttr(it.photoDataUrl)}" style="width:100%;border-radius:14px;border:1px solid rgba(226,232,240,.95)" /></div>` : "";
            const delBtn = `<button class="btn ghost" style="padding:8px 10px" onclick="deleteCheckin('${kind}', ${idx})">åˆ é™¤</button>`;
            return `
              <div class="item">
                <div class="row" style="align-items:flex-start">
                  <div style="flex:1">
                    <p class="t">${title}</p>
                    <p class="m">ğŸ•’ ${when}</p>
                    <p class="m" style="margin-top:6px">${sub}</p>
                  </div>
                  ${delBtn}
                </div>
                ${img}
              </div>
            `;
          }).join("")}
        </div>
      `;
    }

    function deleteCheckin(kind, idx){
      // Note: idx corresponds to current sorted list in modal, so we map by time+title to delete safely.
      // We'll do a simple approach: reconstruct from modal order is hard; instead delete by matching timestamp in modal DOM is complex.
      // For demo, we will delete by re-sorting same way and then removing that entry from original via timestamp.
      const arr = (kind==="workout") ? state.checkins.workouts : state.checkins.meals;
      const sorted = arr.slice().sort((a,b)=>b.at-a.at);
      const target = sorted[idx];
      if(!target) return;
      const newArr = arr.filter(x => !(x.at===target.at && (kind==="workout" ? (x.title===target.title) : (x.mealType===target.mealType && x.desc===target.desc))));
      if(kind==="workout") state.checkins.workouts = newArr;
      else state.checkins.meals = newArr;
      save(state);
      renderAll();
      // reopen modal to refresh
      openModal(kind==="workout" ? "allWorkoutPhotos" : "allMealPhotos");
      toast("å·²åˆ é™¤");
    }

    function toggleReward(i){
      state.rewards[i].ok = !state.rewards[i].ok;
      save(state);
      renderAll();
      openModal("reward");
    }

    function openModalRaw(title, bodyHtml, actions){
      document.getElementById("modalTitle").textContent = title;
      document.getElementById("modalBody").innerHTML = bodyHtml;
      const act = document.getElementById("modalActions");
      act.innerHTML = "";
      actions.forEach(a=>{
        const b = document.createElement("button");
        b.className = "btn " + (a.cls||"");
        b.textContent = a.label;
        b.onclick = a.onClick;
        act.appendChild(b);
      });
      document.getElementById("modal").classList.remove("hidden");
    }

    function closeModal(){
      document.getElementById("modal").classList.add("hidden");
    }

    // ======= Meal calorie estimation (Demo) =======
    function estimateMealCalories(silent){
      const typeEl = document.getElementById("mType");
      const descEl = document.getElementById("mDesc");
      const kcalEl = document.getElementById("mKcal");
      if(!typeEl || !kcalEl) return;

      const mealType = typeEl.value;
      const desc = (descEl?.value || "").toLowerCase();

      // If user wrote a number, try parse
      const numMatch = desc.match(/(\d{2,4})\s*(kcal|åƒå¡|å¡|å¤§å¡)?/i);
      if(numMatch){
        kcalEl.value = String(clamp(Number(numMatch[1]), 0, 5000));
        if(!silent) toast("å·²ä»æè¿°ä¸­è¯†åˆ«çƒ­é‡æ•°å€¼");
        return;
      }

      // Simple keyword boosts
      let base = 0;
      if(mealType==="æ—©é¤") base = 420;
      else if(mealType==="åˆé¤") base = 680;
      else if(mealType==="æ™šé¤") base = 720;
      else base = 260;

      const boosts = [
        { k:"å¥¶èŒ¶", v:220 }, { k:"ç‚¸", v:260 }, { k:"çƒ¤è‚‰", v:280 }, { k:"ç«é”…", v:350 },
        { k:"æŠ«è¨", v:380 }, { k:"æ±‰å ¡", v:320 }, { k:"é¢", v:180 }, { k:"ç±³é¥­", v:160 },
        { k:"æ²™æ‹‰", v:-120 }, { k:"é¸¡èƒ¸", v:-40 }, { k:"é…¸å¥¶", v:-30 }, { k:"åšæœ", v:120 },
        { k:"è›‹ç³•", v:260 }, { k:"ç”œ", v:180 }
      ];
      let delta = 0;
      boosts.forEach(b=>{ if(desc.includes(b.k)) delta += b.v; });

      // small random to look natural
      const jitter = Math.round((Math.random()*0.18 - 0.09) * base);
      const est = clamp(base + delta + jitter, 120, 1800);
      kcalEl.value = String(est);
      if(!silent) toast("å·²ç”Ÿæˆçƒ­é‡ä¼°ç®—ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰");
    }

    // ======= Feedback =======
    function saveFeedback(){
      const timely = document.getElementById("fbTimely").value;
      const practical = document.getElementById("fbPractical").value;
      const note = document.getElementById("fbNote").value.trim();

      state.feedback = { lastAt: Date.now(), timely, practical, note };
      state.messages.push({ level:"info", text:"æ„Ÿè°¢åé¦ˆï¼æˆ‘ä»¬ä¼šåœ¨ä¸‹æœˆæœåŠ¡ä¸­ä¼˜åŒ–æ²Ÿé€šæ–¹å¼ä¸å»ºè®®å¯æ‰§è¡Œæ€§ï¼ˆDemoï¼‰ã€‚" });

      save(state);
      renderAll();
      toast("åé¦ˆå·²æäº¤");
    }

    // ======= Export / Seed =======
    function seedDemo(){
      state = defaultState();
      save(state);
      renderAll();
      toast("å·²é‡ç½®ä¸ºç¤ºä¾‹æ•°æ®");
      go("home");
    }

    function exportData(){
      const json = JSON.stringify(state, null, 2);
      navigator.clipboard?.writeText(json).then(()=>{
        toast("å·²å¤åˆ¶JSONåˆ°å‰ªè´´æ¿");
      }).catch(()=>{
        openModalRaw("å¯¼å‡ºJSON", `
          <textarea style="width:100%;min-height:260px;border-radius:12px;border:1px solid rgba(226,232,240,.95);padding:10px;">${escapeHtml(json)}</textarea>
        `, [{ label:"å…³é—­", cls:"secondary", onClick: closeModal }]);
      });
    }

    // ======= Utils =======
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function pad(n){ return String(n).padStart(2,"0"); }
    function fmtTime(ts){
      const d = new Date(ts);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/\n/g, " "); }

    function toast(text){
      const t = document.createElement("div");
      t.textContent = text;
      Object.assign(t.style,{
        position:"fixed", left:"50%", bottom:"132px",
        transform:"translateX(-50%)",
        background:"rgba(15,23,42,.92)",
        color:"#fff",
        padding:"10px 12px",
        borderRadius:"12px",
        fontSize:"12px",
        zIndex: 200,
        maxWidth:"min(520px, calc(100% - 24px))",
        boxShadow:"0 10px 30px rgba(2,6,23,.35)"
      });
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; t.style.transition="opacity .25s"; }, 1300);
      setTimeout(()=>{ t.remove(); }, 1600);
    }

    // Image compression to base64 (keeps demo self-contained)
    function handlePhotoUpload(){
      const file = document.getElementById("mPhoto").files?.[0];
      const previewBox = document.getElementById("photoPreview");
      if(!file || !previewBox) return;
      
      const reader = new FileReader();
      reader.onload = (e)=>{
        previewBox.innerHTML = `<img src="${e.target.result}" style="width:100%;border-radius:14px;border:1px solid rgba(226,232,240,.95)" />`;
      };
      reader.readAsDataURL(file);
    }
    
    function compressImageToDataUrl(file, maxSide=900, quality=0.82){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        const reader = new FileReader();
        reader.onerror = reject;
        reader.onload = e=>{
          img.onload = ()=>{
            const w = img.width, h = img.height;
            const scale = Math.min(1, maxSide / Math.max(w,h));
            const cw = Math.round(w*scale), ch = Math.round(h*scale);
            const canvas = document.createElement("canvas");
            canvas.width = cw; canvas.height = ch;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, cw, ch);
            const dataUrl = canvas.toDataURL("image/jpeg", quality);
            resolve(dataUrl);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // ======= Init =======
    // Prevent zoom on double-tap and pinch
    document.addEventListener('touchmove', function(e) {
      if (e.touches.length > 1) e.preventDefault();
    }, { passive: false });
    
    document.addEventListener('gesturestart', function(e) {
      e.preventDefault();
    }, false);
    
    // Prevent zoom via keyboard (Ctrl +/-)
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '-' || e.key === '=')) {
        e.preventDefault();
      }
    }, false);
    
    renderAll();
    // å…ˆåˆå§‹åŒ–æ¯æ—¥é¥®é£Ÿè®¡åˆ’
    renderDailyMealPlan("mon");
    go("home");
  </script>
</body>
</html>